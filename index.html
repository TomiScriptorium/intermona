<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dra. Intermona</title>
    
    <!-- --- CONFIGURACI√ìN DE ICONOS --- -->
    <link rel="icon" type="image/png" href="iconointermona.png">
    <link rel="shortcut icon" type="image/png" href="iconointermona.png">
    <link rel="apple-touch-icon" href="iconointermona.png"> 
    
    <!-- PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Intermona">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        :root {
            --medical-pink: #ec4899;
            --medical-pink-light: #fce7f3;
            --medical-blue: #e0f2fe;
            --medical-white: #ffffff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8fafc; /* Gris muy suave, cl√≠nico */
            /* Patr√≥n de papel milimetrado sutil */
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px),
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-handwriting {
            font-family: 'Patrick Hand', cursive;
        }

        /* Estilo Receta M√©dica */
        .rx-paper {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #f3f4f6;
            position: relative;
        }
        .rx-paper::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: var(--medical-pink);
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        /* Animaci√≥n ECG en el t√≠tulo */
        .ecg-line {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 20' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M0 10h10l5-8 5 16 5-8h25'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            animation: ecg-move 2s linear infinite;
        }
        @keyframes ecg-move {
            0% { opacity: 0.3; transform: translateX(-2px); }
            50% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0.3; transform: translateX(2px); }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        .fade-enter { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Botones estilo p√≠ldora */
        .btn-pill {
            border-radius: 9999px;
            transition: all 0.2s;
        }
        .btn-pill:active { transform: scale(0.95); }

        .item-leave {
            transition: all 0.3s ease-in;
            opacity: 0; transform: scale(0.9); height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden;
        }
        
        .badge-clip {
            clip-path: polygon(0% 0%, 100% 0%, 100% 85%, 50% 100%, 0% 85%);
        }

        /* Ajustes Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="text-slate-600 h-screen flex flex-col overflow-hidden">

    <!-- Header Cl√≠nico -->
    <header class="bg-pink-500 text-white pt-safe shadow-lg z-20 shrink-0 relative overflow-hidden">
        <!-- Decoraci√≥n de fondo del header -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(white 1px, transparent 1px); background-size: 10px 10px;"></div>
        
        <div class="p-4 flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3 cursor-pointer" onclick="renderView('dashboard')">
                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm border border-white/30">
                    <i class="fa-solid fa-user-md text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide flex items-center gap-2">
                        Dra. Intermona <span class="ecg-line"></span>
                    </h1>
                    <p class="text-[10px] text-pink-100 uppercase tracking-widest font-semibold">Sistema M√©dico Personal</p>
                </div>
            </div>
            <button onclick="openBackupModal()" class="text-xs bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-full backdrop-blur-md transition shadow-sm border border-white/20 active:scale-95 flex items-center gap-1.5">
                <i class="fa-solid fa-database"></i> <span class="hidden sm:inline">Datos</span>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-28 relative scroll-smooth"></main>

    <!-- Nav Bar Flotante (Estilo Instrumental) -->
    <div class="fixed bottom-0 w-full z-30 pb-safe pointer-events-none">
        <nav class="bg-white mx-4 mb-4 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-gray-100 p-2 pointer-events-auto flex justify-around items-center">
            <button onclick="renderView('dashboard')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="dashboard">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-hospital-user text-xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[9px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase">Inicio</span>
            </button>
            <button onclick="renderView('todo')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="todo">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-clipboard-check text-xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[9px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase">Ronda</span>
            </button>
            <button onclick="renderView('turnario')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="turnario">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-calendar-heart text-xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[9px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase">Calendario</span>
            </button>
            <button onclick="renderView('notes')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="notes">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-file-prescription text-xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[9px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase">Notas</span>
            </button>
            <button onclick="renderView('links')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="links">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-book-medical text-xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[9px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase">Info</span>
            </button>
        </nav>
    </div>

    <!-- Modal Turnario (Estilo Ficha) -->
    <div id="shift-modal" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-0 overflow-hidden transform transition-all scale-100 border-t-4 border-pink-500">
            <div class="bg-pink-50 p-4 border-b border-pink-100 flex justify-between items-center">
                <h3 id="modal-date-title" class="text-lg font-bold text-pink-700">Editar Fecha</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white text-pink-400 flex items-center justify-center hover:bg-pink-100 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="p-6">
                <label class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-stethoscope"></i> Tipo de Asignaci√≥n:</label>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="setShiftType('guardia')" data-type="guardia" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-red-400 hover:text-red-500 font-bold text-xs transition-all flex flex-col items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-user-doctor text-xl"></i> Paso
                    </button>
                    <button onclick="setShiftType('dia')" data-type="dia" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-blue-400 hover:text-blue-500 font-bold text-xs transition-all flex flex-col items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-sun text-xl"></i> Turno D√≠a
                    </button>
                    <button onclick="setShiftType('noche')" data-type="noche" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-indigo-400 hover:text-indigo-500 font-bold text-xs transition-all flex flex-col items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-moon text-xl"></i> Turno Noche
                    </button>
                    <button onclick="setShiftType('post')" data-type="post" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-orange-400 hover:text-orange-500 font-bold text-xs transition-all flex flex-col items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-book-open text-xl"></i> D√≠a de Estudio
                    </button>
                    <button onclick="setShiftType('libre')" data-type="libre" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-green-400 hover:text-green-500 font-bold text-xs transition-all flex flex-col items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-mug-hot text-xl"></i> Libre
                    </button>
                    <button onclick="setShiftType(null)" data-type="null" class="shift-type-btn p-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-400 hover:bg-slate-100 hover:text-slate-600 font-bold text-xs transition-all flex flex-col items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-eraser text-xl"></i> Limpiar
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center gap-3">
                         <i class="fa-regular fa-clock text-slate-400"></i>
                        <input type="time" id="modal-event-time" class="bg-transparent w-full text-sm font-bold text-slate-700 focus:outline-none">
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center gap-3">
                         <i class="fa-solid fa-pen-to-square text-slate-400"></i>
                        <input type="text" id="modal-note-input" class="bg-transparent w-full text-sm font-semibold text-slate-700 focus:outline-none placeholder-slate-400" placeholder="Anotaci√≥n cl√≠nica / Evento...">
                    </div>
                </div>

                <button onclick="saveShift()" class="w-full mt-6 py-3 bg-pink-500 text-white rounded-xl hover:bg-pink-600 shadow-lg shadow-pink-200 transform active:scale-95 transition-all font-bold tracking-wide">
                    <i class="fa-solid fa-floppy-disk mr-2"></i> Guardar Ficha
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Backup -->
    <div id="backup-modal" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2"><i class="fa-solid fa-server"></i> Base de Datos</h3>
                <button onclick="closeBackupModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="downloadBackupFile()" class="p-4 bg-slate-50 border-2 border-slate-100 rounded-xl hover:border-pink-300 hover:bg-pink-50 transition group">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-2 text-pink-500 group-hover:scale-110 transition"><i class="fa-solid fa-download"></i></div>
                        <span class="text-xs font-bold text-slate-600">Exportar</span>
                    </button>
                    <button onclick="exportDataToClipboard()" class="p-4 bg-slate-50 border-2 border-slate-100 rounded-xl hover:border-pink-300 hover:bg-pink-50 transition group">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-2 text-pink-500 group-hover:scale-110 transition"><i class="fa-solid fa-copy"></i></div>
                        <span class="text-xs font-bold text-slate-600">Copiar</span>
                    </button>
                </div>
                <div class="relative border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:bg-slate-50 hover:border-pink-400 transition cursor-pointer group">
                    <input type="file" id="backup-file-input" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importBackupFromFile(this)">
                    <i class="fa-solid fa-file-arrow-up text-3xl text-slate-300 group-hover:text-pink-400 mb-2 transition"></i>
                    <p class="text-sm font-bold text-slate-500">Restaurar Copia</p>
                    <p class="text-[10px] text-slate-400">Seleccionar archivo .json</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6 text-center">
            <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-100">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">¬øConfirmar acci√≥n?</h3>
            <p id="confirm-message" class="text-sm text-slate-500 mb-6">Esta acci√≥n es irreversible.</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeConfirmModal()" class="px-5 py-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 font-bold text-sm">Cancelar</button>
                <button id="confirm-btn-action" class="px-5 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 font-bold text-sm shadow-md shadow-red-200">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Carpeta -->
    <div id="folder-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-folder-plus text-pink-500"></i> Nueva Categor√≠a</h3>
            <input type="text" id="new-folder-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-pink-500 outline-none text-sm font-semibold" placeholder="Ej: Cardiolog√≠a, Pediatr√≠a...">
            <div class="flex justify-end gap-3">
                <button onclick="closeFolderModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-sm">Cancelar</button>
                <button onclick="createFolder()" class="px-4 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 font-bold text-sm shadow-lg shadow-pink-200">Crear</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Nombre (NUEVO) -->
    <div id="name-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-id-card text-pink-500"></i> Editar Nombre</h3>
            <p class="text-xs text-slate-400 mb-3">¬øC√≥mo quieres que te llame la app?</p>
            <input type="text" id="new-user-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-pink-500 outline-none text-sm font-semibold text-slate-700" placeholder="Ej: Dra. Garc√≠a">
            <div class="flex justify-end gap-3">
                <button onclick="closeNameModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-sm">Cancelar</button>
                <button onclick="saveName()" class="px-4 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 font-bold text-sm shadow-lg shadow-pink-200">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Paciente (NUEVO) -->
    <div id="patient-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 border-t-4 border-blue-400">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-user-injured text-blue-500"></i> Ingresar Paciente</h3>
            <div class="space-y-3">
                <input type="text" id="patient-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-semibold" placeholder="Nombre del Paciente">
                <div class="flex gap-3">
                    <input type="text" id="patient-room" class="w-1/3 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-semibold" placeholder="Cama/Hab">
                    <input type="text" id="patient-dx" class="w-2/3 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-semibold" placeholder="Diagn√≥stico (Breve)">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closePatientModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-sm">Cancelar</button>
                <button onclick="createPatient()" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-bold text-sm shadow-lg shadow-blue-200">Ingresar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-all duration-300 pointer-events-none z-[70] flex items-center gap-3 text-sm font-bold translate-y-4">
        <div class="w-6 h-6 bg-pink-500 rounded-full flex items-center justify-center text-[10px]"><i class="fa-solid fa-check"></i></div>
        <span id="toast-msg">Notificaci√≥n</span>
    </div>

    <script>
        const APP_KEY = 'intermona_data_v2'; 
        let state = {
            view: 'dashboard', 
            todos: [],
            notes: [],
            folders: [],
            links: [],
            shifts: {},
            patients: [], // Nueva lista de pacientes
            userProfileImage: null, 
            userName: 'Dra.', 
            currentDate: new Date(),
            currentFolderId: 'all',
            editingNoteId: null
        };

        function init() {
            loadData();
            state.view = null; 
            renderView('dashboard');
        }

        function loadData() {
            const saved = localStorage.getItem(APP_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.todos) parsed.todos = [];
                    if (!parsed.notes) parsed.notes = [];
                    if (!parsed.links) parsed.links = [];
                    if (!parsed.folders) parsed.folders = [{id: 'general', name: 'General'}];
                    if (!parsed.patients) parsed.patients = []; // Inicializar pacientes si no existen
                    if (!parsed.userName) parsed.userName = 'Dra.'; 
                    state = { ...state, ...parsed, currentDate: new Date() }; 
                } catch (e) { 
                    console.error("Error cargando datos, reiniciando...", e);
                    state.folders = [{id: 'general', name: 'General'}];
                }
            } else {
                state.folders = [{id: 'general', name: 'General'}];
                state.todos = [{ id: 1, text: "Bienvenida Dra. Intermona", done: false }];
            }
            if (!state.folders || state.folders.length === 0) state.folders = [{id: 'general', name: 'General'}];
        }

        function saveData() {
            const toSave = { ...state };
            delete toSave.currentDate; 
            delete toSave.editingNoteId; 
            localStorage.setItem(APP_KEY, JSON.stringify(toSave));
        }

        // ... (Funciones de Toast, Backup, Imagen, Nombre igual que antes) ...
        function showToast(msg, icon = 'fa-info-circle') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.querySelector('div').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                toast.classList.remove('translate-y-0');
            }, 3000);
        }

        async function updateProfileImage(input) {
            if (input.files && input.files[0]) {
                try {
                    const base64 = await processImage(input.files[0]);
                    state.userProfileImage = base64;
                    saveData();
                    renderView('dashboard');
                    showToast("Foto actualizada", "fa-camera");
                } catch (e) { showToast("Error al procesar imagen", "fa-triangle-exclamation"); }
            }
        }

        function openNameModal() { document.getElementById('new-user-name').value = state.userName || ''; document.body.classList.add('modal-open'); document.getElementById('name-modal').classList.remove('hidden'); document.getElementById('new-user-name').focus(); }
        function closeNameModal() { document.body.classList.remove('modal-open'); document.getElementById('name-modal').classList.add('hidden'); }
        function saveName() { const name = document.getElementById('new-user-name').value.trim(); if (name) { state.userName = name; saveData(); renderView('dashboard'); closeNameModal(); showToast("Nombre actualizado", "fa-id-card"); } }

        function openBackupModal() { document.getElementById('backup-modal').classList.remove('hidden'); }
        function closeBackupModal() { document.getElementById('backup-modal').classList.add('hidden'); document.getElementById('backup-file-input').value = ''; }
        function downloadBackupFile() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const downloadAnchorNode = document.createElement('a'); const fileName = "intermona_backup_" + new Date().toISOString().slice(0,10) + ".json"; downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", fileName); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showToast("Backup Descargado", "fa-download"); }
        function exportDataToClipboard() { const textArea = document.createElement("textarea"); textArea.value = JSON.stringify(state); textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { if(document.execCommand('copy')) showToast("Copiado al portapapeles", "fa-clipboard-check"); else showToast("Error al copiar", "fa-times"); } catch (err) { showToast("Error al copiar", "fa-times"); } document.body.removeChild(textArea); }
        function importBackupFromFile(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data && (data.todos || data.notes || data.shifts)) { showConfirmModal("Restaurar Datos", "Se sobrescribir√° toda la informaci√≥n actual.", "Restaurar", function() { state = { ...state, ...data, currentDate: new Date() }; saveData(); closeConfirmModal(); closeBackupModal(); state.view = null; renderView('dashboard'); showToast("Base de datos actualizada", "fa-check-double"); }); } else { showToast("Archivo inv√°lido", "fa-triangle-exclamation"); } } catch(err) { showToast("Error leyendo archivo", "fa-bug"); } input.value = ''; }; reader.readAsText(file); }


        // --- FUNCIONES DE PACIENTES (NUEVO) ---
        function openPatientModal() { document.body.classList.add('modal-open'); document.getElementById('patient-modal').classList.remove('hidden'); document.getElementById('patient-name').focus(); }
        function closePatientModal() { document.body.classList.remove('modal-open'); document.getElementById('patient-modal').classList.add('hidden'); document.getElementById('patient-name').value=''; document.getElementById('patient-room').value=''; document.getElementById('patient-dx').value=''; }
        
        function createPatient() {
            const name = document.getElementById('patient-name').value.trim();
            const room = document.getElementById('patient-room').value.trim();
            const dx = document.getElementById('patient-dx').value.trim();
            
            if (!name) return;
            
            const newPatient = {
                id: Date.now(),
                name,
                room: room || '---',
                dx: dx || 'En estudio',
                tasks: []
            };
            
            state.patients.push(newPatient);
            saveData();
            closePatientModal();
            renderView('dashboard');
            showToast("Paciente Ingresado", "fa-user-plus");
        }

        function deletePatient(id) {
            showConfirmModal("¬øDar de alta?", "Se eliminar√° la ficha y pendientes.", "Dar de Alta", () => {
                state.patients = state.patients.filter(p => p.id !== id);
                saveData();
                closeConfirmModal();
                renderView('dashboard');
                showToast("Paciente dado de alta", "fa-user-minus");
            });
        }

        function addPatientTask(patientId) {
            const input = document.getElementById(`new-task-${patientId}`);
            const text = input.value.trim();
            if(!text) return;
            
            const patient = state.patients.find(p => p.id === patientId);
            if(patient) {
                patient.tasks.push({ id: Date.now(), text, done: false });
                saveData();
                // Re-render parcial o total. Total es m√°s seguro por ahora.
                renderView('dashboard'); 
            }
        }
        
        function togglePatientTask(patientId, taskId) {
            const patient = state.patients.find(p => p.id === patientId);
            if(patient) {
                const task = patient.tasks.find(t => t.id === taskId);
                if(task) {
                    task.done = !task.done;
                    saveData();
                    renderView('dashboard');
                }
            }
        }

        function deletePatientTask(patientId, taskId) {
             const patient = state.patients.find(p => p.id === patientId);
             if(patient) {
                 patient.tasks = patient.tasks.filter(t => t.id !== taskId);
                 saveData();
                 renderView('dashboard');
             }
        }


        // --- SISTEMA DE NAVEGACI√ìN ---
        function renderView(viewName) {
            const container = document.getElementById('app-container');
            
            state.view = viewName;
            state.editingNoteId = null; 
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const icon = btn.querySelector('i');
                if(btn.dataset.target === viewName) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            let contentHTML = '';
            
            // CAMBIO: Ahora tanto 'dashboard' como 'notes' usan el ancho completo (w-full)
            // Agregamos max-w-7xl para que en pantallas gigantes no se estire infinito, pero llene laptops normales.
            let containerClass = "fade-enter h-full "; 
            
            if (viewName === 'dashboard' || viewName === 'notes') {
                containerClass += "w-full max-w-7xl mx-auto"; 
            } else {
                containerClass += "max-w-md mx-auto"; // Turnario, Ronda y Links siguen centrados y angostos
            }

            try {
                switch(viewName) {
                    case 'dashboard': contentHTML = getDashboardHTML(); break;
                    case 'turnario': contentHTML = getTurnarioHTML(); break;
                    case 'todo': contentHTML = getTodoHTML(); break;
                    case 'notes': contentHTML = getNotesHTML(); break;
                    case 'links': contentHTML = getLinksHTML(); break;
                    default: contentHTML = getDashboardHTML(); 
                }
            } catch (e) {
                console.error("Error renderizando vista:", e);
                contentHTML = `<div class="p-8 text-center text-red-400">Error de renderizado.</div>`;
            }

            const wrapper = document.createElement('div');
            wrapper.className = containerClass;
            wrapper.innerHTML = contentHTML;

            container.replaceChildren(wrapper);
            container.scrollTop = 0;
            
            if (viewName === 'notes') {
                const imgInput = document.getElementById('new-note-image');
                if(imgInput) imgInput.addEventListener('change', function() { previewImage(this); });
            }
            saveData();
        }

        // --- DASHBOARD (REDDISE√ëADO - FULL WIDTH) ---
        function getDashboardHTML() {
            const today = new Date();
            const dateKey = today.toISOString().split('T')[0];
            let shift = state.shifts[dateKey];
            let isNextShift = false;
            let nextDateStr = "";

            if (!shift) {
                const futureDates = Object.keys(state.shifts).filter(date => date > dateKey).sort();
                if (futureDates.length > 0) {
                    const nextDateKey = futureDates[0];
                    shift = state.shifts[nextDateKey];
                    isNextShift = true;
                    const [y, m, d] = nextDateKey.split('-').map(Number);
                    nextDateStr = new Date(y, m - 1, d).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
                }
            }

            // Datos para columna derecha (Widgets)
            let nextEvent = null;
            const sortedDates = Object.keys(state.shifts).sort();
            for (const d of sortedDates) {
                if (d >= dateKey && state.shifts[d].eventTime && state.shifts[d].note) {
                    nextEvent = { date: d, ...state.shifts[d] };
                    break; 
                }
            }

            // HTML Strings pre-generados para ordenamiento flexible
            
            // 1. Recordatorio
            let reminderHTML = '';
            if (nextEvent) {
                const [y, m, d] = nextEvent.date.split('-').map(Number);
                const isTodayEvent = nextEvent.date === dateKey;
                const eventDateStr = new Date(y, m - 1, d).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                // AGREGADO: shrink-0 para evitar aplastamiento
                reminderHTML = `
                    <div class="order-3 bg-gradient-to-r from-indigo-500 to-blue-500 text-white p-4 rounded-2xl shadow-lg shadow-indigo-200 flex items-center gap-4 relative overflow-hidden shrink-0">
                        <div class="bg-white/20 p-3 rounded-xl backdrop-blur-sm"><i class="fa-solid fa-bell text-xl"></i></div>
                        <div class="flex-1 z-10">
                            <p class="text-[10px] uppercase tracking-wider opacity-80 font-bold">Recordatorio</p>
                            <h4 class="font-bold text-lg leading-tight">${nextEvent.note}</h4>
                            <p class="text-xs mt-1 font-medium opacity-90"><i class="fa-regular fa-calendar mr-1"></i> ${isTodayEvent ? 'HOY' : eventDateStr} ‚Ä¢ ${nextEvent.eventTime}</p>
                        </div>
                    </div>`;
            }

            // 2. Datos de Turno y Frases
            const pendingTodos = (state.todos || []).filter(t => !t.done);
            const lovePhrases = ["¬°Turno exitoso, Dra!", "La mejor doctora ü´Ä", "¬°A salvar vidas!", "Vocaci√≥n y coraz√≥n ü©∑", "Dra. Monita al rescate"];
            const greeting = lovePhrases[Math.floor(Math.random() * lovePhrases.length)];

            let shiftCardClass = "bg-white border-slate-200 text-slate-500";
            let shiftText = "Sin turnos asignados";
            let shiftSubText = "Revisa tu calendario";
            let shiftIcon = "fa-calendar-check"; 

            if (shift) {
                if (shift.type === 'guardia') { 
                    shiftCardClass = "bg-red-50 border-red-100 text-red-600"; 
                    shiftText = "PASO"; 
                    shiftSubText = "Visita de Sala"; 
                    shiftIcon = "fa-user-doctor";
                }
                else if (shift.type === 'dia') { shiftCardClass = "bg-blue-50 border-blue-100 text-blue-600"; shiftText = "TURNO D√çA"; shiftSubText = "Jornada Diurna"; shiftIcon = "fa-sun"; }
                else if (shift.type === 'noche') { shiftCardClass = "bg-indigo-50 border-indigo-100 text-indigo-600"; shiftText = "TURNO NOCHE"; shiftSubText = "Jornada Nocturna"; shiftIcon = "fa-moon"; }
                else if (shift.type === 'post') { 
                    shiftCardClass = "bg-orange-50 border-orange-100 text-orange-600"; 
                    shiftText = "D√çA DE ESTUDIO"; 
                    shiftSubText = "Tiempo de estudio"; 
                    shiftIcon = "fa-book-open";
                }
                else if (shift.type === 'libre') { shiftCardClass = "bg-emerald-50 border-emerald-100 text-emerald-600"; shiftText = "D√çA LIBRE"; shiftSubText = "Recarga energ√≠as"; shiftIcon = "fa-mug-hot"; }
                if (isNextShift && shift.type !== 'libre') shiftSubText = `Pr√≥ximo: ${nextDateStr}`;
            }

            const profileImageSrc = state.userProfileImage || 'catita.png';
            const displayUserName = state.userName || 'Dra.';

            // 3. Generaci√≥n HTML Lista Pacientes
            const patientsListContent = (state.patients || []).length === 0 
                ? `<div class="bg-white p-8 rounded-2xl border-2 border-dashed border-slate-200 text-center flex flex-col items-center justify-center h-48">
                     <i class="fa-solid fa-bed-pulse text-4xl text-slate-200 mb-2"></i>
                     <p class="text-slate-400 font-bold text-sm">Sin pacientes ingresados</p>
                     <p class="text-slate-300 text-xs">Agrega uno para comenzar ronda</p>
                   </div>`
                : (state.patients || []).map(p => {
                    const tasksHTML = p.tasks.map(t => `
                        <div class="flex items-center gap-2 group/task mb-1">
                            <button onclick="togglePatientTask(${p.id}, ${t.id})" class="text-sm ${t.done ? 'text-green-500' : 'text-slate-300 hover:text-pink-500'} transition"><i class="fa-${t.done ? 'solid' : 'regular'} fa-circle-check"></i></button>
                            <span class="text-xs flex-1 ${t.done ? 'text-slate-400 line-through' : 'text-slate-600 font-medium'}">${t.text}</span>
                            <button onclick="deletePatientTask(${p.id}, ${t.id})" class="text-slate-200 hover:text-red-400 opacity-0 group-hover/task:opacity-100 transition"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    `).join('');

                    return `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition group relative mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-slate-700 text-lg leading-none">${p.name}</h4>
                                <div class="flex gap-2 mt-1">
                                    <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider"><i class="fa-solid fa-bed mr-1"></i> ${p.room}</span>
                                    <span class="bg-slate-50 text-slate-500 px-2 py-0.5 rounded text-[10px] font-bold uppercase truncate max-w-[120px]">${p.dx}</span>
                                </div>
                            </div>
                            <button onclick="deletePatient(${p.id})" class="text-slate-300 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        <div class="mt-3 pl-1 border-l-2 border-slate-100">
                            ${tasksHTML}
                            <div class="flex items-center gap-2 mt-2">
                                <input type="text" id="new-task-${p.id}" placeholder="+ Pendiente..." class="bg-transparent text-xs outline-none w-full placeholder-slate-300 focus:placeholder-blue-300 text-slate-600" onkeypress="if(event.key === 'Enter') addPatientTask(${p.id})">
                                <button onclick="addPatientTask(${p.id})" class="text-blue-400 hover:text-blue-600 text-xs"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>`;
                }).join('');

            // LAYOUT
            // AGREGADO: shrink-0 en todos los divs de widgets para que no se compriman
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-full min-h-full pb-8">
                    
                    <!-- PACIENTES (Fichas) -->
                    <div class="order-4 lg:order-1 lg:col-span-1 lg:min-w-[350px] flex flex-col lg:h-full h-auto">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#f8fafc] z-10 py-2">
                            <h2 class="text-2xl font-black text-slate-700 flex items-center gap-2"><i class="fa-solid fa-clipboard-user text-blue-500"></i> Fichas</h2>
                            <button onclick="openPatientModal()" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition"><i class="fa-solid fa-plus mr-1"></i> Ingresar</button>
                        </div>
                        <div class="lg:flex-1 lg:overflow-y-auto lg:pr-1 w-full">
                            ${patientsListContent}
                        </div>
                    </div>

                    <!-- WRAPPER WIDGETS -->
                    <div class="contents lg:flex lg:flex-col lg:gap-6 lg:order-2 lg:col-span-2 lg:overflow-y-auto lg:p-6 lg:h-full">
                        
                        <!-- 1. Perfil (Orden 1) -->
                        <div class="order-1 flex items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 shrink-0">
                            <div class="relative w-16 h-16 shrink-0 group cursor-pointer">
                                <div class="absolute inset-0 bg-pink-100 rounded-full animate-pulse"></div>
                                <label for="profile-upload" class="cursor-pointer">
                                    <img src="${profileImageSrc}" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow relative z-10 group-hover:opacity-80 transition" onerror="this.src='https://via.placeholder.com/64?text=Dra'">
                                    <div class="absolute inset-0 z-20 flex items-center justify-center bg-black/30 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-white text-xs"></i></div>
                                </label>
                                <input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="updateProfileImage(this)">
                                <div class="absolute -bottom-1 -right-1 bg-green-400 w-5 h-5 rounded-full border-2 border-white flex items-center justify-center z-20 pointer-events-none"><i class="fa-solid fa-check text-[10px] text-white"></i></div>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Estado Actual</p>
                                <h2 class="text-xl font-bold text-slate-700 leading-tight flex items-center gap-2 cursor-pointer hover:text-pink-600 transition" onclick="openNameModal()" title="Clic para editar nombre">Hola, ${displayUserName} <i class="fa-solid fa-pen-to-square text-xs text-slate-300"></i></h2>
                                <p class="text-sm text-pink-500 font-medium italic">"${greeting}"</p>
                            </div>
                        </div>

                        <!-- 2. Turno (Orden 2) -->
                        <div onclick="renderView('turnario')" class="order-2 cursor-pointer relative overflow-hidden rounded-2xl border-2 ${shiftCardClass.replace('bg-', 'border-').replace('text-', 'border-')} p-0 transition-transform active:scale-95 shadow-sm shrink-0">
                            <div class="${shiftCardClass} p-5 relative z-10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-1 block">Asignaci√≥n ${isNextShift ? 'Pr√≥xima' : 'de Hoy'}</span>
                                        <h3 class="text-2xl font-black tracking-tight mb-1">${shiftText}</h3>
                                        <p class="text-sm font-medium opacity-80 flex items-center gap-1"><i class="fa-solid fa-circle-info text-xs"></i> ${shiftSubText}</p>
                                    </div>
                                    <div class="w-12 h-12 rounded-xl bg-white/50 flex items-center justify-center backdrop-blur-sm shadow-sm"><i class="fa-solid ${shiftIcon} text-2xl opacity-90"></i></div>
                                </div>
                            </div>
                            <div class="absolute -right-4 -bottom-8 opacity-10 pointer-events-none"><i class="fa-solid fa-heart-pulse text-9xl"></i></div>
                        </div>

                        <!-- 3. Recordatorio (Orden 3) -->
                        ${reminderHTML}

                        <!-- 5. Botones R√°pidos (Orden 5) -->
                        <div class="order-5 grid grid-cols-2 gap-3 shrink-0">
                            <div onclick="renderView('todo')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 hover:border-pink-200 transition group cursor-pointer">
                                <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-clipboard-list text-lg"></i></div>
                                <span class="text-xs font-bold text-slate-600">Pendientes (${pendingTodos.length})</span>
                            </div>
                            <div onclick="renderView('notes')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 hover:border-blue-200 transition group cursor-pointer">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-file-medical text-lg"></i></div>
                                <span class="text-xs font-bold text-slate-600">Mis Apuntes</span>
                            </div>
                        </div>

                        <!-- 6. Staff (Orden 6) -->
                        <div class="order-6 pt-4 border-t border-slate-200/60 pb-8 shrink-0">
                             <p class="text-[10px] text-center text-slate-400 uppercase tracking-widest font-bold mb-4">Equipo M√©dico de Guardia</p>
                            <div class="flex justify-center gap-6">
                                 <div class="relative group"><div class="absolute -inset-1 bg-gradient-to-r from-pink-400 to-purple-400 rounded-full blur opacity-25 group-hover:opacity-50 transition"></div><img src="catita.png" class="w-20 h-20 object-contain relative z-10 drop-shadow-lg transform hover:scale-110 transition duration-300" onerror="this.style.display='none'"></div>
                                 <div class="relative group"><div class="absolute -inset-1 bg-gradient-to-r from-blue-400 to-teal-400 rounded-full blur opacity-25 group-hover:opacity-50 transition"></div><img src="catita2.png" class="w-20 h-20 object-contain relative z-10 drop-shadow-lg transform hover:scale-110 transition duration-300" onerror="this.style.display='none'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- CALENDAR WRAPPERS ---
        function getTurnarioHTML() {
            const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            let html = `
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                        <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-pink-600 hover:bg-white rounded-full transition shadow-sm border border-transparent hover:border-slate-100"><i class="fa-solid fa-chevron-left"></i></button>
                        <div class="text-center">
                            <h2 class="text-lg font-black text-slate-700 uppercase tracking-wide">${monthNames[month]}</h2>
                            <p class="text-xs text-slate-400 font-bold">${year}</p>
                        </div>
                        <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-pink-600 hover:bg-white rounded-full transition shadow-sm border border-transparent hover:border-slate-100"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    
                    <div class="p-3">
                        <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                            <div class="text-[10px] font-bold text-pink-400 uppercase">L</div>
                            <div class="text-[10px] font-bold text-pink-400 uppercase">M</div>
                            <div class="text-[10px] font-bold text-pink-400 uppercase">X</div>
                            <div class="text-[10px] font-bold text-pink-400 uppercase">J</div>
                            <div class="text-[10px] font-bold text-pink-400 uppercase">V</div>
                            <div class="text-[10px] font-bold text-slate-300 uppercase">S</div>
                            <div class="text-[10px] font-bold text-slate-300 uppercase">D</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1.5">
            `;
            
            for (let i = 0; i < startingDay; i++) html += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) { const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; html += createDayCellHTML(dateKey, day); }
            html += `
                        </div>
                    </div>
                    <div class="bg-slate-50 p-3 border-t border-slate-100 grid grid-cols-3 gap-2 text-[9px] font-bold text-slate-500 uppercase tracking-wide">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Paso</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> D√≠a</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-indigo-600"></span> Noche</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-400"></span> Estudio</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Libre</span>
                    </div>
                </div>
            `; 
            return html;
        }

        function createDayCellHTML(dateKey, day) {
            const shift = state.shifts[dateKey]; 
            let bgClass = "bg-white text-slate-600 hover:bg-pink-50 border border-slate-100"; 
            let content = `<span class="text-sm font-bold z-10 relative">${day}</span>`;
            
            if (shift) { 
                if (shift.type === 'guardia') { bgClass = "bg-red-500 text-white border-red-500 shadow-md shadow-red-200"; } 
                else if (shift.type === 'dia') { bgClass = "bg-blue-500 text-white border-blue-500 shadow-md shadow-blue-200"; } 
                else if (shift.type === 'noche') { bgClass = "bg-indigo-600 text-white border-indigo-600 shadow-md shadow-indigo-200"; } 
                else if (shift.type === 'post') { bgClass = "bg-orange-100 text-orange-600 border-orange-200"; content += `<i class="fa-solid fa-book-open absolute text-[10px] bottom-1 opacity-50"></i>`; } 
                else if (shift.type === 'libre') { bgClass = "bg-emerald-100 text-emerald-600 border-emerald-200"; content += `<i class="fa-solid fa-face-smile absolute text-[10px] bottom-1 opacity-50"></i>`; } 
            }
            
            const todayKey = new Date().toISOString().split('T')[0]; 
            if (dateKey === todayKey) {
                bgClass += " ring-2 ring-pink-400 ring-offset-1 z-20";
            }

            let dots = "";
            if (shift && (shift.note || shift.eventTime)) {
                dots = `<div class="absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-yellow-400 border border-white"></div>`;
            }

            return `<div onclick="openShiftModal('${dateKey}')" class="aspect-square rounded-xl flex items-center justify-center relative cursor-pointer transition-transform active:scale-90 ${bgClass}">${content}${dots}</div>`;
        }

        function changeMonth(delta) { state.currentDate.setMonth(state.currentDate.getMonth() + delta); renderView('turnario'); }
        
        let selectedDateKey = null; 
        let tempShiftType = null;
        
        function openShiftModal(dateKey) { 
            selectedDateKey = dateKey; 
            const shift = state.shifts[dateKey]; 
            const [y, m, d] = dateKey.split('-'); 
            const dateObj = new Date(y, m-1, d); 
            const dateTitle = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); 
            
            document.getElementById('modal-date-title').innerText = dateTitle; 
            document.getElementById('modal-note-input').value = shift ? (shift.note || '') : ''; 
            document.getElementById('modal-event-time').value = shift ? (shift.eventTime || '') : ''; 
            
            tempShiftType = shift ? shift.type : null; 
            updateShiftTypeUI(); 
            document.body.classList.add('modal-open'); 
            document.getElementById('shift-modal').classList.remove('hidden'); 
        }
        
        function setShiftType(type) { tempShiftType = type; updateShiftTypeUI(); }
        
        function updateShiftTypeUI() { 
            document.querySelectorAll('.shift-type-btn').forEach(btn => { 
                btn.classList.remove('ring-2', 'ring-pink-500', 'bg-pink-50', 'text-pink-600', 'border-pink-200'); 
                if (String(tempShiftType) === btn.dataset.type) {
                    btn.classList.add('ring-2', 'ring-pink-500', 'bg-pink-50', 'text-pink-600', 'border-pink-200');
                    btn.classList.remove('text-slate-500', 'bg-white');
                }
            }); 
        }
        
        function closeModal() { document.body.classList.remove('modal-open'); document.getElementById('shift-modal').classList.add('hidden'); }
        
        function saveShift() { 
            const note = document.getElementById('modal-note-input').value.trim(); 
            const eventTime = document.getElementById('modal-event-time').value; 
            
            if (!tempShiftType && !note && !eventTime) {
                delete state.shifts[selectedDateKey]; 
            } else { 
                state.shifts[selectedDateKey] = { type: tempShiftType, note: note, eventTime: eventTime }; 
            } 
            saveData(); 
            closeModal(); 
            if (state.view === 'turnario') { 
                const [y, m, d] = selectedDateKey.split('-'); 
                renderView('turnario'); // Refrescar todo el mes para simplificar
            } else if (state.view === 'dashboard') { renderView('dashboard'); } 
            showToast("Ficha Actualizada", "fa-check"); 
        }

        // --- NOTES SYSTEM (Estilo Recetario) ---
        function getNotesHTML() {
            // Generamos el HTML de las carpetas pero lo insertaremos en la columna derecha
            const foldersHTML = `
                <div class="flex overflow-x-auto gap-2 pb-2 mb-0 no-scrollbar" id="folders-container">
                    ${generateFoldersHTML()}
                </div>
            `;

            return `
                <div class="h-full flex flex-col">
                    <div class="flex justify-between items-end mb-4 shrink-0">
                        <h2 class="text-2xl font-black text-slate-700">Recetario & Notas</h2>
                        <i class="fa-solid fa-feather text-pink-300 text-xl"></i>
                    </div>
                    
                    <!-- Layout Responsivo: Columna √∫nica en m√≥vil, Dos columnas en escritorio -->
                    <div class="flex flex-col lg:flex-row gap-6 flex-1 lg:overflow-hidden">
                        
                        <!-- Columna Izquierda: Editor (Sticky en desktop) -->
                        <div class="lg:w-1/3 lg:min-w-[320px] shrink-0">
                            <div id="note-editor" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative lg:h-auto transition-all">
                                <div class="absolute top-0 left-4 w-full h-1 bg-gradient-to-r from-pink-300 via-pink-400 to-pink-300"></div>
                                <div class="flex justify-between items-center mb-3">
                                    <span id="editor-title" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nueva Entrada</span>
                                    <button id="editor-cancel-btn" onclick="cancelEdit()" class="text-slate-400 hover:text-red-400 text-xs hidden"><i class="fa-solid fa-times"></i> Cancelar</button>
                                </div>
                                
                                <textarea id="new-note-text" class="w-full p-2 border border-slate-100 rounded-xl focus:ring-2 focus:ring-pink-100 focus:border-pink-200 outline-none resize-none mb-3 font-handwriting text-xl text-slate-600 bg-slate-50 leading-relaxed placeholder-slate-300 transition-all" rows="6" placeholder="Escribe aqu√≠, doctora..."></textarea>
                                
                                <div id="image-preview-container" class="hidden mb-3 relative group w-fit">
                                    <img id="image-preview" src="" class="h-24 rounded-lg border border-slate-200 object-cover shadow-sm">
                                    <button onclick="clearImageInput()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center transform scale-90 shadow"><i class="fa-solid fa-xmark text-[10px]"></i></button>
                                </div>

                                <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                                    <label class="cursor-pointer text-slate-500 hover:text-pink-600 transition flex items-center gap-2 text-xs font-bold bg-slate-50 border border-slate-100 px-3 py-2 rounded-xl hover:bg-pink-50 hover:border-pink-200">
                                        <i class="fa-solid fa-camera"></i> Adjuntar
                                        <input type="file" id="new-note-image" accept="image/*" class="hidden">
                                    </label>
                                    <button id="editor-save-btn" onclick="saveNote()" class="bg-slate-800 text-white px-6 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 transform active:scale-95 transition-all shadow-lg shadow-slate-200">
                                        <i class="fa-solid fa-check mr-1"></i> Anotar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tip visual para desktop -->
                            <p class="hidden lg:block text-center text-[10px] text-slate-300 mt-4 italic">
                                <i class="fa-solid fa-lightbulb text-yellow-300 mr-1"></i> Selecciona una nota de la derecha para editarla aqu√≠.
                            </p>
                        </div>

                        <!-- Columna Derecha: Filtros y Lista (Con scroll independiente) -->
                        <div class="lg:w-2/3 flex flex-col lg:h-full min-h-0">
                            <!-- Barra de Carpetas -->
                            <div class="mb-4 shrink-0 bg-[#f8fafc] sticky top-0 z-10 pb-2">
                                ${foldersHTML}
                            </div>
                            
                            <!-- Lista de Notas (Grid en desktop, lista en m√≥vil) -->
                            <div class="flex-1 lg:overflow-y-auto pr-1 pb-20 lg:pb-0">
                                <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 auto-rows-min">
                                    ${generateNotesListHTML()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateFoldersHTML() {
             return `
                <button onclick="changeFolder('all')" class="whitespace-nowrap px-4 py-1.5 rounded-lg text-xs font-bold transition-all border ${state.currentFolderId === 'all' ? 'bg-slate-700 text-white border-slate-700 shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:border-pink-300'}" data-id="all">Todas</button>
                ${(state.folders || []).map(f => `
                    <button onclick="changeFolder('${f.id}')" class="whitespace-nowrap px-4 py-1.5 rounded-lg text-xs font-bold transition-all border ${state.currentFolderId === f.id ? 'bg-pink-500 text-white border-pink-500 shadow-md' : 'bg-white text-slate-500 border-slate-200 hover:border-pink-300'}" data-id="${f.id}">${f.name}</button>
                `).join('')}
                <button onclick="openFolderModal()" class="w-8 h-8 rounded-lg bg-pink-50 text-pink-500 hover:bg-pink-100 flex items-center justify-center border border-pink-100 transition"><i class="fa-solid fa-plus text-xs"></i></button>
            `;
        }

        function generateNotesListHTML() {
            let filteredNotes = state.notes || [];
            if (state.currentFolderId !== 'all') { filteredNotes = filteredNotes.filter(n => n.folderId === state.currentFolderId); }
            if (filteredNotes.length === 0) return `<div class="text-center py-10 opacity-40"><i class="fa-solid fa-clipboard text-4xl mb-2 text-slate-300"></i><p class="text-xs font-bold text-slate-400">Sin notas registradas</p></div>`;
            return filteredNotes.map(n => createNoteHTML(n)).join('');
        }

        function createNoteHTML(note) {
            const img = note.image ? `<img src="${note.image}" class="w-full h-auto rounded-lg mb-3 border border-slate-100">` : '';
            const folderName = (state.folders || []).find(f => f.id === note.folderId)?.name || 'General';
            
            return `
                <div id="note-${note.id}" class="rx-paper p-5 rounded-r-xl rounded-l-md item-enter group hover:-translate-y-1 transition-transform duration-300">
                    <div class="absolute top-3 right-3 opacity-20 group-hover:opacity-100 transition text-slate-300 text-2xl rotate-12"><i class="fa-solid fa-user-doctor"></i></div>
                    ${img}
                    <p class="text-slate-700 whitespace-pre-wrap font-handwriting text-xl leading-relaxed relative z-10">${note.text}</p>
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-dashed border-slate-200">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50 px-2 py-1 rounded">${folderName}</span>
                        <div class="flex gap-2 opacity-60 group-hover:opacity-100 transition">
                             <button onclick="startEditNote(${note.id})" class="text-slate-400 hover:text-blue-500 px-1"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="confirmDelete('note', ${note.id})" class="text-slate-400 hover:text-red-500 px-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeFolder(folderId) {
            state.currentFolderId = folderId;
            document.getElementById('folders-container').innerHTML = generateFoldersHTML();
            document.getElementById('notes-list').innerHTML = generateNotesListHTML();
        }

        function startEditNote(id) {
            state.editingNoteId = id;
            const note = state.notes.find(n => n.id === id);
            if(!note) return;
            document.getElementById('editor-title').innerText = "Editando Registro";
            document.getElementById('editor-save-btn').innerHTML = `<i class="fa-solid fa-rotate mr-1"></i> Actualizar`;
            document.getElementById('editor-cancel-btn').classList.remove('hidden');
            document.getElementById('new-note-text').value = note.text;
            if(note.image) {
                document.getElementById('image-preview').src = note.image;
                document.getElementById('image-preview-container').classList.remove('hidden');
            } else { clearImageInput(); }
            document.getElementById('note-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function cancelEdit() {
            state.editingNoteId = null;
            document.getElementById('editor-title').innerText = "Nueva Entrada";
            document.getElementById('editor-save-btn').innerHTML = `<i class="fa-solid fa-check mr-1"></i> Anotar`;
            document.getElementById('editor-cancel-btn').classList.add('hidden');
            document.getElementById('new-note-text').value = '';
            clearImageInput();
        }

        async function saveNote() {
            const textInput = document.getElementById('new-note-text');
            const fileInput = document.getElementById('new-note-image');
            const imgPreview = document.getElementById('image-preview');
            const text = textInput.value.trim();
            const file = fileInput.files[0];
            let imageData = null;

            if (!text && !file && imgPreview.classList.contains('hidden')) return showToast("Nota vac√≠a", "fa-pen");

            if (file) {
                try { imageData = await processImage(file); } 
                catch (e) { return showToast("Error imagen", "fa-times"); }
            } else if (!document.getElementById('image-preview-container').classList.contains('hidden')) {
                imageData = imgPreview.src;
            }

            if (state.editingNoteId) {
                const noteIndex = state.notes.findIndex(n => n.id === state.editingNoteId);
                if (noteIndex > -1) {
                    state.notes[noteIndex].text = text;
                    state.notes[noteIndex].image = imageData;
                }
                cancelEdit();
                showToast("Registro actualizado", "fa-rotate");
            } else {
                const targetFolder = state.currentFolderId === 'all' ? 'general' : state.currentFolderId;
                const newNote = { id: Date.now(), text, image: imageData, folderId: targetFolder };
                state.notes.unshift(newNote);
                textInput.value = '';
                clearImageInput();
                showToast("Nota guardada", "fa-check");
            }
            saveData();
            document.getElementById('notes-list').innerHTML = generateNotesListHTML();
        }

        function deleteNote(id) {
            state.notes = state.notes.filter(n => n.id !== id);
            saveData();
            const el = document.getElementById(`note-${id}`);
            if(el) { el.classList.add('item-leave'); setTimeout(() => el.remove(), 300); }
            showToast("Nota eliminada", "fa-trash");
        }
        
        // --- TODO LIST (Estilo Checklist M√©dico) ---
        function getTodoHTML() {
            const todosHTML = state.todos.length === 0 
                ? `<div class="text-center py-12 opacity-50"><i class="fa-solid fa-list-check text-4xl mb-2 text-pink-200"></i><p class="text-sm font-bold text-pink-300">¬°Todo despejado, doctora!</p></div>`
                : state.todos.sort((a,b) => a.done - b.done).map(t => createTodoItemHTML(t)).join('');

            return `
                <div>
                    <div class="bg-blue-600 text-white p-6 rounded-2xl mb-6 shadow-lg shadow-blue-200 relative overflow-hidden">
                        <div class="relative z-10">
                            <h2 class="text-2xl font-black mb-1">Ronda de Tareas</h2>
                            <p class="text-blue-100 text-sm">Lista de pendientes y objetivos.</p>
                        </div>
                        <i class="fa-solid fa-clipboard-check absolute -right-2 -bottom-4 text-8xl text-blue-500 opacity-50 rotate-12"></i>
                    </div>

                    <div class="flex gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                        <input type="text" id="new-todo" placeholder="Agregar nueva tarea..." class="flex-1 p-3 bg-transparent outline-none text-slate-700 font-medium placeholder-slate-400" onkeypress="if(event.key === 'Enter') addTodo()">
                        <button onclick="addTodo()" class="bg-pink-500 text-white w-12 rounded-lg hover:bg-pink-600 transition shadow-sm font-bold text-lg">+</button>
                    </div>
                    
                    <ul id="todo-list" class="space-y-3 pb-20">${todosHTML}</ul>
                </div>
            `;
        }

        function createTodoItemHTML(todo) {
            const doneClass = todo.done ? "opacity-60 bg-slate-50 border-slate-100" : "bg-white border-slate-100 border-l-4 border-l-pink-400";
            const textClass = todo.done ? "line-through text-slate-400" : "text-slate-700 font-bold";
            const iconClass = todo.done ? "fa-solid fa-circle-check text-green-500" : "fa-regular fa-circle text-slate-300 group-hover:text-pink-400";
            
            return `
                <li id="todo-${todo.id}" class="flex items-center gap-4 p-4 rounded-xl shadow-sm border ${doneClass} transition-all group item-enter">
                    <button onclick="toggleTodo(${todo.id})" class="text-xl focus:outline-none transform active:scale-90 transition"><i id="icon-${todo.id}" class="${iconClass}"></i></button>
                    <span id="text-${todo.id}" class="flex-1 ${textClass} cursor-pointer select-none" onclick="toggleTodo(${todo.id})">${todo.text}</span>
                    <button onclick="confirmDelete('todo', ${todo.id})" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                </li>`;
        }

        function addTodo() {
            const input = document.getElementById('new-todo');
            const text = input.value.trim();
            if (!text) return;
            const newTodo = { id: Date.now(), text, done: false };
            state.todos.unshift(newTodo);
            saveData();
            document.getElementById('todo-list').innerHTML = state.todos.sort((a,b) => a.done - b.done).map(t => createTodoItemHTML(t)).join('');
            input.value = '';
            showToast("Tarea a√±adida", "fa-plus");
        }

        function toggleTodo(id) {
            const todo = state.todos.find(t => t.id === id);
            if (!todo) return;
            todo.done = !todo.done;
            saveData();
            // Re-render completo para ordenar
            document.getElementById('todo-list').innerHTML = state.todos.sort((a,b) => a.done - b.done).map(t => createTodoItemHTML(t)).join('');
        }
        function deleteTodo(id) {
            state.todos = state.todos.filter(t => t.id !== id);
            saveData();
            const el = document.getElementById(`todo-${id}`);
            if (el) { el.classList.add('item-leave'); setTimeout(() => el.remove(), 300); }
        }

        // --- LINKS (Estilo Biblioteca) ---
        function getLinksHTML() {
            const linksHTML = state.links.map(l => createLinkHTML(l)).join('');
            return `
                <div>
                    <h2 class="text-2xl font-black text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-book-medical text-pink-500"></i> Biblioteca & Links</h2>
                    <div class="bg-white p-5 rounded-2xl shadow-sm mb-6 border border-slate-100">
                        <div class="flex flex-col gap-3">
                            <input type="text" id="link-title" placeholder="Nombre del recurso" class="p-3 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:bg-white focus:border-pink-300 transition">
                            <div class="flex gap-2">
                                <input type="url" id="link-url" placeholder="https://..." class="flex-1 p-3 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:bg-white focus:border-pink-300 transition">
                                <button onclick="addLink()" class="bg-slate-800 text-white px-4 rounded-xl font-bold hover:bg-slate-700 transition shadow-lg shadow-slate-200">Guardar</button>
                            </div>
                        </div>
                    </div>
                    <div id="links-list" class="grid gap-3 pb-20">${linksHTML}</div>
                </div>
            `;
        }
        function createLinkHTML(link) {
            const favicon = `https://www.google.com/s2/favicons?domain=${link.url}&sz=64`;
            return `
                <div id="link-${link.id}" class="flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition hover:border-pink-100 group">
                    <img src="${favicon}" class="w-10 h-10 rounded-lg bg-slate-50 p-1.5 mr-4 object-contain" onerror="this.src='https://via.placeholder.com/32'">
                    <a href="${link.url}" target="_blank" class="flex-1 text-slate-700 font-bold hover:text-pink-600 transition truncate pr-4">
                        ${link.title}
                        <div class="text-[10px] text-slate-400 font-normal truncate mt-0.5">${link.url}</div>
                    </a>
                    <button onclick="confirmDelete('link', ${link.id})" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                </div>`;
        }
        function addLink() {
            const t = document.getElementById('link-title').value.trim();
            let u = document.getElementById('link-url').value.trim();
            if (!t || !u) return;
            if (!u.startsWith('http')) u = 'https://' + u;
            const newLink = { id: Date.now(), title: t, url: u };
            state.links.push(newLink);
            saveData();
            document.getElementById('links-list').innerHTML = state.links.map(l => createLinkHTML(l)).join(''); // Re-render simple
            document.getElementById('link-title').value = '';
            document.getElementById('link-url').value = '';
            showToast("Recurso a√±adido", "fa-bookmark");
        }
        function deleteLink(id) {
            state.links = state.links.filter(l => l.id !== id);
            saveData();
            const el = document.getElementById(`link-${id}`);
            if(el) { el.classList.add('item-leave'); setTimeout(() => el.remove(), 300); }
        }

        // --- UTILS ---
        function openFolderModal() { document.body.classList.add('modal-open'); document.getElementById('folder-modal').classList.remove('hidden'); document.getElementById('new-folder-name').focus(); }
        function closeFolderModal() { document.body.classList.remove('modal-open'); document.getElementById('folder-modal').classList.add('hidden'); document.getElementById('new-folder-name').value = ''; }
        function createFolder() {
            const name = document.getElementById('new-folder-name').value.trim();
            if (!name) return;
            const id = 'f_' + Date.now();
            state.folders.push({ id, name });
            state.currentFolderId = id; 
            saveData();
            closeFolderModal();
            changeFolder(id); // Forzar refresh
            showToast(`Categor√≠a "${name}" creada`, "fa-folder-plus");
        }
        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        function previewImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('image-preview'); if(img) { img.src = e.target.result; document.getElementById('image-preview-container').classList.remove('hidden'); } }; reader.readAsDataURL(input.files[0]); } }
        function clearImageInput() { document.getElementById('new-note-image').value = ''; document.getElementById('image-preview-container').classList.add('hidden'); document.getElementById('image-preview').src = ''; }

        function showConfirmModal(title, message, actionBtnText, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('h3').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            const btn = document.getElementById('confirm-btn-action');
            btn.innerText = actionBtnText;
            btn.onclick = onConfirm;
            document.body.classList.add('modal-open');
            modal.classList.remove('hidden');
        }
        function closeConfirmModal() { document.body.classList.remove('modal-open'); document.getElementById('confirm-modal').classList.add('hidden'); }
        function confirmDelete(type, id) {
            let msg = "Esta acci√≥n es definitiva.";
            if(type === 'todo') msg = "¬øCompletar o borrar esta tarea?";
            if(type === 'note') msg = "¬øEliminar este registro cl√≠nico?";
            if(type === 'link') msg = "¬øEliminar este recurso?";

            showConfirmModal("¬øEst√°s segura?", msg, "Eliminar", function() {
                if (type === 'todo') deleteTodo(id);
                else if (type === 'note') deleteNote(id);
                else if (type === 'link') deleteLink(id);
                closeConfirmModal();
            });
        }

        init();
    </script>
</body>
</html>
