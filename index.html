<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Intermona - Organizaci√≥n M√©dica</title>
    
    <!-- Configuraci√≥n de Iconos (Favicon, iOS, Desktop) -->
    <link rel="icon" type="image/png" href="iconointermona.png">
    <link rel="shortcut icon" type="image/png" href="iconointermona.png">
    <link rel="apple-touch-icon" href="iconointermona.png">
    
    <!-- Meta tags para modo App en iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Intermona">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-handwriting {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.1rem;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        .fade-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .item-enter {
            animation: slideIn 0.3s ease-out forwards;
        }

        .item-leave {
            transition: all 0.3s ease-in;
            opacity: 0;
            transform: scale(0.95);
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
        }

        .item-update {
            animation: pulse-green 0.5s ease-in-out;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }

        .calendar-day { aspect-ratio: 1/1; }
        body.modal-open { overflow: hidden; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-pink-600 text-white p-4 shadow-md flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="renderView('dashboard')">
            <!-- Icono Original Restaurado -->
            <i class="fa-solid fa-user-doctor text-2xl"></i>
            <h1 class="text-xl font-bold tracking-wide">Intermona</h1>
        </div>
        <button onclick="openBackupModal()" class="text-xs bg-pink-700 px-3 py-1 rounded hover:bg-pink-800 transition shadow-sm active:scale-95 transform flex items-center gap-1" title="Gestionar Copias de Seguridad">
            <i class="fa-solid fa-cloud-arrow-down"></i> Backup
        </button>
    </header>

    <!-- Main Container -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-24 relative bg-gray-50 scroll-smooth"></main>

    <!-- Nav Bar -->
    <nav class="fixed bottom-0 w-full bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] border-t border-gray-100 z-30 pb-safe">
        <div class="flex justify-around items-center h-16">
            <button onclick="renderView('dashboard')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-pink-600 transition-colors" data-target="dashboard">
                <i class="fa-solid fa-house text-xl mb-1 transition-transform"></i>
                <span class="text-[10px] font-semibold">Inicio</span>
            </button>
            <button onclick="renderView('todo')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-pink-600 transition-colors" data-target="todo">
                <i class="fa-solid fa-check-double text-xl mb-1 transition-transform"></i>
                <span class="text-[10px] font-semibold">Tareas</span>
            </button>
            <button onclick="renderView('turnario')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-pink-600 transition-colors" data-target="turnario">
                <i class="fa-solid fa-calendar-days text-xl mb-1 transition-transform"></i>
                <span class="text-[10px] font-semibold">Calendario</span>
            </button>
            <button onclick="renderView('notes')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-pink-600 transition-colors" data-target="notes">
                <i class="fa-solid fa-sticky-note text-xl mb-1 transition-transform"></i>
                <span class="text-[10px] font-semibold">Notas</span>
            </button>
            <button onclick="renderView('links')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-pink-600 transition-colors" data-target="links">
                <i class="fa-solid fa-link text-xl mb-1 transition-transform"></i>
                <span class="text-[10px] font-semibold">Links</span>
            </button>
        </div>
    </nav>

    <!-- Modal Turnario -->
    <div id="shift-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="modal-date-title" class="text-lg font-bold text-gray-700">Editar Fecha</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-wide text-xs">Tipo de Turno:</label>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="setShiftType('guardia')" data-type="guardia" class="shift-type-btn p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 border border-red-100 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2"><i class="fa-solid fa-bell"></i> Guardia 24h</button>
                <button onclick="setShiftType('dia')" data-type="dia" class="shift-type-btn p-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-100 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2"><i class="fa-solid fa-sun"></i> Turno D√≠a</button>
                <button onclick="setShiftType('noche')" data-type="noche" class="shift-type-btn p-2 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-100 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2"><i class="fa-solid fa-moon"></i> Turno Noche</button>
                <button onclick="setShiftType('post')" data-type="post" class="shift-type-btn p-2 rounded-lg bg-orange-50 text-orange-600 hover:bg-orange-100 border border-orange-100 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2"><i class="fa-solid fa-bed"></i> Post-G</button>
                <button onclick="setShiftType('libre')" data-type="libre" class="shift-type-btn p-2 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 border border-green-100 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2"><i class="fa-solid fa-mug-hot"></i> Libre</button>
                <button onclick="setShiftType(null)" data-type="null" class="shift-type-btn p-2 rounded-lg bg-gray-50 text-gray-500 hover:bg-gray-100 border border-gray-200 font-semibold text-sm transition-all duration-200 flex items-center justify-center gap-2"><i class="fa-solid fa-trash-can"></i> Borrar</button>
            </div>

            <div class="flex gap-2 mb-2">
                <div class="w-1/3">
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Hora (Opc):</label>
                    <input type="time" id="modal-event-time" class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm bg-gray-50">
                </div>
                <div class="w-2/3">
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Nota / Evento:</label>
                    <input type="text" id="modal-note-input" class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm bg-gray-50" placeholder="Ej: Examen final">
                </div>
            </div>

            <div class="flex justify-end mt-6 gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg font-medium">Cancelar</button>
                <button onclick="saveShift()" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 shadow-lg transform active:scale-95 transition-all font-bold">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Backup / Restaurar -->
    <div id="backup-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-floppy-disk text-pink-500"></i> Copia de Seguridad</h3>
                    <p class="text-xs text-gray-500">Guarda tus datos o c√°rgalos en otro dispositivo.</p>
                </div>
                <button onclick="closeBackupModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">1. Guardar tus datos (Exportar)</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="downloadBackupFile()" class="p-3 bg-pink-50 border border-pink-100 rounded-lg text-pink-700 text-sm font-bold flex flex-col items-center gap-1 hover:bg-pink-100 transition">
                        <i class="fa-solid fa-file-arrow-down text-xl"></i>
                        Descargar
                    </button>
                    <button onclick="exportDataToClipboard()" class="p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-600 text-sm font-bold flex flex-col items-center gap-1 hover:bg-gray-100 transition">
                        <i class="fa-solid fa-copy text-xl"></i>
                        Copiar
                    </button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide">2. Recuperar datos (Importar)</label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-pink-300 transition relative">
                    <input type="file" id="backup-file-input" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="importBackupFromFile(this)">
                    <i class="fa-solid fa-file-import text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm text-gray-600 font-medium">Toca aqu√≠ para subir archivo</p>
                    <p class="text-xs text-gray-400">(.json)</p>
                </div>
                <p class="text-[10px] text-red-400 mt-2 text-center"><i class="fa-solid fa-triangle-exclamation"></i> Importar sobrescribir√° los datos actuales.</p>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n Gen√©rico -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center transform transition-all scale-100">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">¬øEst√°s seguro?</h3>
            <p id="confirm-message" class="text-sm text-gray-500 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">Cancelar</button>
                <button id="confirm-btn-action" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium shadow-md">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Carpeta -->
    <div id="folder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Nueva Carpeta</h3>
            <input type="text" id="new-folder-name" class="w-full p-3 border border-gray-200 rounded-lg mb-4 focus:ring-2 focus:ring-pink-500 outline-none" placeholder="Nombre (ej. Cardiolog√≠a)">
            <div class="flex justify-end gap-3">
                <button onclick="closeFolderModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button onclick="createFolder()" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 font-bold">Crear</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-all duration-300 pointer-events-none z-[70] flex items-center gap-2 text-sm font-medium translate-y-2">
        <i class="fa-solid fa-info-circle"></i> <span id="toast-msg">Mensaje</span>
    </div>

    <script>
        const APP_KEY = 'intermona_data_v2'; 
        let state = {
            view: 'dashboard', 
            todos: [],
            notes: [],
            folders: [],
            links: [],
            shifts: {},
            currentDate: new Date(),
            currentFolderId: 'all',
            editingNoteId: null
        };

        function init() {
            loadData();
            state.view = null; 
            renderView('dashboard');
        }

        function loadData() {
            const saved = localStorage.getItem(APP_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.todos) parsed.todos = [];
                    if (!parsed.notes) parsed.notes = [];
                    if (!parsed.links) parsed.links = [];
                    if (!parsed.folders) parsed.folders = [{id: 'general', name: 'General'}];
                    state = { ...state, ...parsed, currentDate: new Date() }; 
                } catch (e) { 
                    console.error("Error cargando datos, reiniciando...", e);
                    state.folders = [{id: 'general', name: 'General'}];
                }
            } else {
                state.folders = [{id: 'general', name: 'General'}];
                state.todos = [{ id: 1, text: "Bienvenido a Intermona", done: false }];
            }
            if (!state.folders || state.folders.length === 0) state.folders = [{id: 'general', name: 'General'}];
        }

        function saveData() {
            const toSave = { ...state };
            delete toSave.currentDate; 
            delete toSave.editingNoteId; 
            localStorage.setItem(APP_KEY, JSON.stringify(toSave));
        }

        function showToast(msg, icon = 'fa-info-circle') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.querySelector('i').className = `fa-solid ${icon}`;
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.classList.remove('translate-y-0');
            }, 3000);
        }

        // --- SISTEMA DE BACKUP ---
        function openBackupModal() {
            document.body.classList.add('modal-open');
            document.getElementById('backup-modal').classList.remove('hidden');
        }

        function closeBackupModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('backup-modal').classList.add('hidden');
            document.getElementById('backup-file-input').value = '';
        }

        function downloadBackupFile() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            const fileName = "intermona_backup_" + new Date().toISOString().slice(0,10) + ".json";
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Archivo descargado", "fa-download");
        }

        function exportDataToClipboard() {
            const textArea = document.createElement("textarea");
            textArea.value = JSON.stringify(state);
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                if(document.execCommand('copy')) showToast("Copia realizada al portapapeles", "fa-clipboard-check");
                else showToast("Error al copiar", "fa-times");
            } catch (err) {
                showToast("Error al copiar", "fa-times");
            }
            document.body.removeChild(textArea);
        }

        function importBackupFromFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && (data.todos || data.notes || data.shifts)) {
                        showConfirmModal(
                            "Restaurar Copia",
                            "Se reemplazar√°n todos los datos actuales por los del archivo. ¬øContinuar?",
                            "Restaurar",
                            function() {
                                state = { ...state, ...data, currentDate: new Date() };
                                saveData();
                                closeConfirmModal();
                                closeBackupModal();
                                state.view = null;
                                renderView('dashboard');
                                showToast("Datos restaurados", "fa-check-double");
                            }
                        );
                    } else {
                        showToast("Archivo inv√°lido", "fa-triangle-exclamation");
                    }
                } catch(err) {
                    console.error(err);
                    showToast("Error leyendo archivo", "fa-bug");
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // --- SISTEMA DE NAVEGACI√ìN ---
        function renderView(viewName) {
            const container = document.getElementById('app-container');
            if (state.view === viewName && container.childElementCount > 0) return; 

            state.view = viewName;
            state.editingNoteId = null; 
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const icon = btn.querySelector('i');
                if(btn.dataset.target === viewName) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-pink-600');
                    icon.classList.add('scale-110');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-pink-600');
                    icon.classList.remove('scale-110');
                }
            });

            let contentHTML = '';
            try {
                switch(viewName) {
                    case 'dashboard': contentHTML = getDashboardHTML(); break;
                    case 'turnario': contentHTML = getTurnarioHTML(); break;
                    case 'todo': contentHTML = getTodoHTML(); break;
                    case 'notes': contentHTML = getNotesHTML(); break;
                    case 'links': contentHTML = getLinksHTML(); break;
                    default: contentHTML = getDashboardHTML(); 
                }
            } catch (e) {
                console.error("Error renderizando vista:", e);
                contentHTML = `<div class="p-8 text-center text-red-400">Algo sali√≥ mal.</div>`;
            }

            const wrapper = document.createElement('div');
            wrapper.className = "fade-enter max-w-lg mx-auto";
            wrapper.innerHTML = contentHTML;

            container.replaceChildren(wrapper);
            container.scrollTop = 0;
            
            if (viewName === 'notes') {
                const imgInput = document.getElementById('new-note-image');
                if(imgInput) imgInput.addEventListener('change', function() { previewImage(this); });
            }
            saveData();
        }

        // --- DASHBOARD ---
        function getDashboardHTML() {
            const today = new Date();
            const dateKey = today.toISOString().split('T')[0];
            let shift = state.shifts[dateKey];
            let isNextShift = false;
            let daysUntil = 0;
            let nextDateStr = "";

            if (!shift) {
                const futureDates = Object.keys(state.shifts).filter(date => date > dateKey).sort();
                if (futureDates.length > 0) {
                    const nextDateKey = futureDates[0];
                    shift = state.shifts[nextDateKey];
                    isNextShift = true;
                    const diffTime = Math.abs(new Date(nextDateKey) - new Date(dateKey));
                    daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const [y, m, d] = nextDateKey.split('-').map(Number);
                    nextDateStr = new Date(y, m - 1, d).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                }
            }

            let nextEvent = null;
            const sortedDates = Object.keys(state.shifts).sort();
            for (const d of sortedDates) {
                if (d >= dateKey && state.shifts[d].eventTime && state.shifts[d].note) {
                    nextEvent = { date: d, ...state.shifts[d] };
                    break; 
                }
            }

            let reminderHTML = '';
            if (nextEvent) {
                const [y, m, d] = nextEvent.date.split('-').map(Number);
                const eventDateObj = new Date(y, m - 1, d);
                const isTodayEvent = nextEvent.date === dateKey;
                const eventDateStr = eventDateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                
                reminderHTML = `
                    <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-2xl shadow-sm flex items-start gap-3 relative overflow-hidden mb-4">
                        <div class="bg-indigo-100 text-indigo-600 w-10 h-10 rounded-full flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div class="flex-1 z-10">
                            <p class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-0.5">Pr√≥ximo Evento</p>
                            <h4 class="font-bold text-gray-800 text-lg leading-tight">${nextEvent.note}</h4>
                            <p class="text-sm text-indigo-600 mt-1 font-medium">
                                ${isTodayEvent ? '¬°Hoy!' : eventDateStr} a las ${nextEvent.eventTime}
                            </p>
                        </div>
                        <i class="fa-regular fa-bell absolute -right-3 -bottom-3 text-6xl text-indigo-100 opacity-50 transform rotate-12"></i>
                    </div>
                `;
            }

            const pendingTodos = (state.todos || []).filter(t => !t.done);
            
            const lovePhrases = [
                "Eres la m√°s monita üêµü©∑", "Te amo popii", "Ser√°s la mejor intermona ü©∑",
                "Pop pop pop pop", "Eres el amor de mi vida", "Ahora mismo estoy pensando en ti üíò",
                "Un poquito m√°s...", "Quiero monitaaaaaaaaa", "Eres la mejor ü©∑",
                "Eres mi pop", "Te amo te amo te amo", "Mi doctora mona üíï",
                "Siempre estar√© para intermona", "Beshona", "Hola quiero a mi polola", "POP"
            ];
            const hour = today.getHours();
            const phraseIndex = (Math.floor(hour / 2) + today.getDate()) % lovePhrases.length;
            let greeting = lovePhrases[phraseIndex];

            let shiftCardClass = "bg-white border-gray-200 text-gray-600";
            let shiftText = "No hay turnos pr√≥ximos";
            let shiftIcon = "fa-calendar-check"; 
            let cardIconColor = "text-gray-300";

            if (shift) {
                if (shift.type === 'guardia') { shiftCardClass = "bg-gradient-to-br from-red-500 to-red-600 text-white border-red-600 shadow-red-200"; shiftText = "Guardia 24h"; shiftIcon = "fa-truck-medical"; cardIconColor = "text-white/30"; }
                else if (shift.type === 'dia') { shiftCardClass = "bg-gradient-to-br from-blue-500 to-blue-600 text-white border-blue-600 shadow-blue-200"; shiftText = "Turno de D√≠a"; shiftIcon = "fa-sun"; cardIconColor = "text-white/30"; }
                else if (shift.type === 'noche') { shiftCardClass = "bg-gradient-to-br from-indigo-600 to-indigo-700 text-white border-indigo-700 shadow-indigo-200"; shiftText = "Turno de Noche"; shiftIcon = "fa-moon"; cardIconColor = "text-white/30"; }
                else if (shift.type === 'post') { shiftCardClass = "bg-gradient-to-br from-orange-400 to-orange-500 text-white border-orange-500 shadow-orange-200"; shiftText = "Post-Guardia"; shiftIcon = "fa-bed"; cardIconColor = "text-white/30"; }
                else if (shift.type === 'libre') { shiftCardClass = "bg-gradient-to-br from-green-500 to-green-600 text-white border-green-600 shadow-green-200"; shiftText = "D√≠a Libre"; shiftIcon = "fa-mug-hot"; cardIconColor = "text-white/30"; }

                if (isNextShift && shift.type !== 'libre') {
                     shiftCardClass = "bg-white border-l-4 border-l-" + (shift.type === 'guardia' ? 'red' : shift.type === 'dia' ? 'blue' : shift.type === 'noche' ? 'indigo' : 'orange') + "-500 border-gray-200 text-gray-700";
                     cardIconColor = (shift.type === 'guardia' ? 'text-red' : shift.type === 'dia' ? 'text-blue' : shift.type === 'noche' ? 'text-indigo' : 'text-orange') + "-100";
                     shiftText = `<span class="text-${shift.type === 'guardia' ? 'red' : shift.type === 'dia' ? 'blue' : 'indigo'}-600 font-bold">${shiftText}</span>`;
                }
            }

            return `
                <div class="space-y-5">
                    <div class="flex justify-between items-end mb-2 px-1">
                        <div>
                            <h2 class="text-2xl font-bold text-pink-600 leading-tight">${greeting}</h2>
                            <p class="text-sm text-gray-500 capitalize">${today.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        </div>
                    </div>

                    <div onclick="renderView('turnario')" class="cursor-pointer p-6 rounded-2xl shadow-lg border relative overflow-hidden ${shiftCardClass} flex items-center justify-between transition-transform transform hover:scale-[1.01] active:scale-95">
                        <div class="z-10 relative w-full">
                            <p class="text-xs font-bold uppercase tracking-wider mb-2 flex items-center gap-1 opacity-90">
                                ${isNextShift ? '<i class="fa-solid fa-clock rotate-12"></i> PR√ìXIMO' : '<i class="fa-solid fa-calendar-day"></i> HOY'} 
                                ${isNextShift ? `<span class="font-normal opacity-80">(${daysUntil} d√≠as)</span>` : ''}
                            </p>
                            <h3 class="text-2xl font-bold leading-tight">${shiftText}</h3>
                            ${isNextShift ? `<p class="text-xs mt-1 opacity-80">${nextDateStr}</p>` : ''}
                        </div>
                        <i class="fa-solid ${shiftIcon} text-6xl absolute -right-2 -bottom-4 ${cardIconColor} transform -rotate-12"></i>
                    </div>

                    ${reminderHTML}

                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700 flex items-center gap-2">
                                <span class="bg-pink-100 text-pink-600 w-8 h-8 flex items-center justify-center rounded-lg"><i class="fa-solid fa-list-check"></i></span>
                                Pendientes <span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full ml-1">${pendingTodos.length}</span>
                            </h3>
                            <button onclick="renderView('todo')" class="text-xs text-pink-600 font-bold hover:underline">Ver todo</button>
                        </div>
                        ${pendingTodos.length === 0 
                            ? `<p class="text-center text-gray-400 text-sm py-2">¬°Todo al d√≠a! üéâ</p>` 
                            : `<ul class="space-y-3">
                                ${pendingTodos.slice(0, 3).map(t => `<li class="flex items-start gap-3 text-sm text-gray-600"><i class="fa-regular fa-square text-pink-500 mt-1"></i><span class="truncate pt-0.5">${t.text}</span></li>`).join('')}
                               </ul>`
                        }
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="renderView('notes')" class="bg-yellow-50 p-4 rounded-2xl shadow-sm border border-yellow-100 cursor-pointer hover:bg-yellow-100 transition group relative overflow-hidden">
                            <i class="fa-solid fa-note-sticky absolute -right-3 -top-3 text-6xl text-yellow-100 group-hover:text-yellow-200 transition-colors transform rotate-12"></i>
                            <h3 class="font-bold text-gray-700 text-sm mb-2 relative z-10">Notas</h3>
                            <p class="text-xs text-gray-500 relative z-10">Ver tus apuntes</p>
                        </div>
                        <div onclick="renderView('turnario')" class="bg-pink-50 p-4 rounded-2xl shadow-sm border border-pink-100 cursor-pointer hover:bg-pink-100 transition group relative overflow-hidden">
                            <i class="fa-solid fa-calendar absolute -right-3 -top-3 text-6xl text-pink-100 group-hover:text-pink-200 transition-colors transform rotate-12"></i>
                            <h3 class="font-bold text-gray-700 text-sm mb-2 relative z-10">Calendario</h3>
                            <p class="text-xs text-gray-500 relative z-10">Ver mes completo</p>
                        </div>
                    </div>

                    <!-- NUEVOS STICKERS -->
                    <div class="flex justify-center gap-6 mt-8 pb-4">
                        <img src="catita.png" alt="Sticker 1" class="w-28 h-28 object-contain drop-shadow-md hover:scale-110 transition-transform transform -rotate-3" onerror="this.style.display='none'">
                        <img src="catita2.png" alt="Sticker 2" class="w-28 h-28 object-contain drop-shadow-md hover:scale-110 transition-transform transform rotate-3" onerror="this.style.display='none'">
                    </div>
                </div>
            `;
        }

        // --- CALENDAR WRAPPERS ---
        function getTurnarioHTML() {
             const year = state.currentDate.getFullYear(); const month = state.currentDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            let html = `<div><div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-pink-600 active:bg-gray-100 rounded-full"><i class="fa-solid fa-chevron-left"></i></button><h2 class="text-lg font-bold text-gray-800 capitalize">${monthNames[month]} <span class="text-pink-600">${year}</span></h2><button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-pink-600 active:bg-gray-100 rounded-full"><i class="fa-solid fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-2 mb-2 text-center text-[10px] font-bold text-gray-400 uppercase tracking-widest"><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-1.5 sm:gap-2">`;
            for (let i = 0; i < startingDay; i++) html += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) { const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; html += createDayCellHTML(dateKey, day); }
            html += `</div><div class="mt-6 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 text-xs text-gray-500 grid grid-cols-3 gap-2"><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-red-500"></span> Guardia</span><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-blue-500"></span> D√≠a</span><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-indigo-600"></span> Noche</span><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-orange-300"></span> Post</span><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-green-400"></span> Libre</span></div></div>`; return html;
        }

        function createDayCellHTML(dateKey, day) {
            const shift = state.shifts[dateKey]; 
            let bgClass = "bg-white border-gray-100 text-gray-600 hover:border-pink-200"; 
            let icon = "";
            if (shift) { 
                if (shift.type === 'guardia') { bgClass = "bg-red-500 border-red-600 text-white shadow-md shadow-red-200"; icon = "üö®"; } 
                else if (shift.type === 'dia') { bgClass = "bg-blue-500 border-blue-600 text-white shadow-md shadow-blue-200"; icon = "‚òÄÔ∏è"; } 
                else if (shift.type === 'noche') { bgClass = "bg-indigo-600 border-indigo-700 text-white shadow-md shadow-indigo-200"; icon = "üåô"; } 
                else if (shift.type === 'post') { bgClass = "bg-orange-100 border-orange-200 text-orange-700"; icon = "üí§"; } 
                else if (shift.type === 'libre') { bgClass = "bg-green-100 border-green-200 text-green-700"; icon = "üåø"; } 
            }
            const todayKey = new Date().toISOString().split('T')[0]; 
            const isToday = dateKey === todayKey ? "ring-2 ring-pink-500 ring-offset-1 z-10" : ""; 
            
            let noteIndicator = "";
            if (shift) {
                if (shift.eventTime) {
                    noteIndicator = `<div class="absolute top-1 right-1 text-[8px] ${['guardia','dia','noche'].includes(shift.type) ? 'text-white' : 'text-indigo-600'}"><i class="fa-solid fa-clock"></i></div>`;
                } else if (shift.note) {
                    noteIndicator = `<div class="absolute top-1 right-1 w-1.5 h-1.5 bg-yellow-400 rounded-full shadow-sm"></div>`;
                }
            }

            return `<div id="day-${dateKey}" onclick="openShiftModal('${dateKey}')" class="relative calendar-day cursor-pointer rounded-xl border flex flex-col items-center justify-center transition-all active:scale-90 ${bgClass} ${isToday}">${noteIndicator}<span class="text-sm font-bold ${shift && ['guardia','dia','noche'].includes(shift.type) ? 'text-white' : ''}">${day}</span>${shift && !['post','libre'].includes(shift.type) && !icon ? '' : `<span class="text-[10px] leading-none mt-0.5 opacity-80">${icon}</span>`}</div>`;
        }

        function changeMonth(delta) { state.currentDate.setMonth(state.currentDate.getMonth() + delta); renderView('turnario'); }
        
        let selectedDateKey = null; 
        let tempShiftType = null;
        
        function openShiftModal(dateKey) { 
            selectedDateKey = dateKey; 
            const shift = state.shifts[dateKey]; 
            const [y, m, d] = dateKey.split('-'); 
            const dateObj = new Date(y, m-1, d); 
            const dateTitle = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); 
            
            document.getElementById('modal-date-title').innerText = dateTitle.charAt(0).toUpperCase() + dateTitle.slice(1); 
            document.getElementById('modal-note-input').value = shift ? (shift.note || '') : ''; 
            document.getElementById('modal-event-time').value = shift ? (shift.eventTime || '') : ''; 
            
            tempShiftType = shift ? shift.type : null; 
            updateShiftTypeUI(); 
            document.body.classList.add('modal-open'); 
            document.getElementById('shift-modal').classList.remove('hidden'); 
        }
        
        function setShiftType(type) { tempShiftType = type; updateShiftTypeUI(); }
        
        function updateShiftTypeUI() { 
            document.querySelectorAll('.shift-type-btn').forEach(btn => { 
                btn.classList.remove('ring-2', 'ring-pink-400', 'shadow-sm'); 
                if (String(tempShiftType) === btn.dataset.type) btn.classList.add('ring-2', 'ring-pink-400', 'shadow-sm'); 
            }); 
        }
        
        function closeModal() { document.body.classList.remove('modal-open'); document.getElementById('shift-modal').classList.add('hidden'); }
        
        function saveShift() { 
            const note = document.getElementById('modal-note-input').value.trim(); 
            const eventTime = document.getElementById('modal-event-time').value; 
            
            if (!tempShiftType && !note && !eventTime) {
                delete state.shifts[selectedDateKey]; 
            } else { 
                state.shifts[selectedDateKey] = { 
                    type: tempShiftType, 
                    note: note,
                    eventTime: eventTime 
                }; 
            } 
            
            saveData(); 
            closeModal(); 
            
            if (state.view === 'turnario') { 
                const dayEl = document.getElementById(`day-${selectedDateKey}`); 
                if(dayEl) { const [y, m, d] = selectedDateKey.split('-'); dayEl.outerHTML = createDayCellHTML(selectedDateKey, parseInt(d)); } 
            } else if (state.view === 'dashboard') { 
                renderView('dashboard'); 
            } 
            showToast("Guardado", "fa-check"); 
        }

        // --- NOTES SYSTEM ---
        function getNotesHTML() {
            const foldersHTML = `
                <div class="flex overflow-x-auto gap-2 pb-4 mb-2 no-scrollbar" id="folders-container">
                    ${generateFoldersHTML()}
                </div>
            `;

            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Notas</h2>
                    ${foldersHTML}
                    
                    <div id="note-editor" class="bg-white p-4 rounded-2xl shadow-sm mb-6 border border-gray-100 transition-all">
                        <div class="flex justify-between items-center mb-2">
                            <span id="editor-title" class="text-xs font-bold text-gray-400 uppercase">Nueva Nota</span>
                            <button id="editor-cancel-btn" onclick="cancelEdit()" class="text-gray-400 hover:text-gray-600 text-sm mr-3 hidden">Cancelar</button>
                        </div>
                        <textarea id="new-note-text" class="w-full p-2 border-b border-gray-100 focus:outline-none focus:border-pink-300 resize-none mb-2 font-handwriting text-lg bg-transparent" rows="3" placeholder="Nota nueva..."></textarea>
                        
                        <div id="image-preview-container" class="hidden mb-3 relative group w-fit">
                            <img id="image-preview" src="" class="h-24 rounded-lg border border-gray-200 object-cover shadow-sm">
                            <button onclick="clearImageInput()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center transform scale-90"><i class="fa-solid fa-xmark text-xs"></i></button>
                        </div>

                        <div class="flex justify-between items-center mt-3">
                            <label class="cursor-pointer text-gray-500 hover:text-pink-600 flex items-center gap-2 text-xs font-bold">
                                <i class="fa-solid fa-camera"></i> Foto
                                <input type="file" id="new-note-image" accept="image/*" class="hidden">
                            </label>
                            <button id="editor-save-btn" onclick="saveNote()" class="bg-pink-600 text-white px-5 py-1.5 rounded-lg text-sm font-bold hover:bg-pink-700 transform active:scale-95 transition-transform shadow-md">Guardar</button>
                        </div>
                    </div>
                    <div id="notes-list" class="grid grid-cols-1 gap-4 pb-20 masonry-layout">
                        ${generateNotesListHTML()}
                    </div>
                </div>
            `;
        }

        function generateFoldersHTML() {
             return `
                <button onclick="changeFolder('all')" class="folder-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all ${state.currentFolderId === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200'}" data-id="all">
                    Todas
                </button>
                ${(state.folders || []).map(f => `
                    <button onclick="changeFolder('${f.id}')" class="folder-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all ${state.currentFolderId === f.id ? 'bg-pink-600 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-200'}" data-id="${f.id}">
                        ${f.name}
                    </button>
                `).join('')}
                <button onclick="openFolderModal()" class="whitespace-nowrap px-3 py-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                    <i class="fa-solid fa-plus"></i>
                </button>
            `;
        }

        function generateNotesListHTML() {
            let filteredNotes = state.notes || [];
            if (state.currentFolderId !== 'all') {
                filteredNotes = filteredNotes.filter(n => n.folderId === state.currentFolderId);
            }
            if (filteredNotes.length === 0) return `<div class="text-center text-gray-400 text-sm mt-10 italic flex flex-col items-center"><i class="fa-regular fa-folder-open text-3xl mb-2 opacity-50"></i>Carpeta vac√≠a</div>`;
            return filteredNotes.map(n => createNoteHTML(n)).join('');
        }

        function createNoteHTML(note) {
            const img = note.image ? `<img src="${note.image}" class="w-full h-auto rounded-lg mb-3 border border-black/5">` : '';
            const folderName = (state.folders || []).find(f => f.id === note.folderId)?.name || 'General';
            
            return `
                <div id="note-${note.id}" class="bg-yellow-50 p-5 rounded-xl shadow-sm border border-yellow-200/60 relative group item-enter hover:shadow-md transition-shadow">
                    ${img}
                    <p class="text-gray-800 whitespace-pre-wrap font-handwriting text-lg leading-relaxed">${note.text}</p>
                    <div class="flex justify-between items-center mt-4 pt-2 border-t border-yellow-200/50">
                        <span class="text-[10px] text-gray-400 bg-white/50 px-2 py-0.5 rounded-full">${folderName}</span>
                        <div class="flex gap-2">
                             <button onclick="copyNote(${note.id})" class="text-gray-400 hover:text-blue-500 bg-white rounded-full w-7 h-7 shadow-sm flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-copy text-xs"></i>
                            </button>
                             <button onclick="startEditNote(${note.id})" class="text-gray-400 hover:text-pink-500 bg-white rounded-full w-7 h-7 shadow-sm flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-pencil text-xs"></i>
                            </button>
                            <button onclick="confirmDelete('note', ${note.id})" class="text-red-300 hover:text-red-500 bg-white rounded-full w-7 h-7 shadow-sm flex items-center justify-center transition-colors">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeFolder(folderId) {
            state.currentFolderId = folderId;
            document.querySelectorAll('.folder-btn').forEach(btn => {
                if(btn.dataset.id === folderId) {
                    btn.className = "folder-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all bg-pink-600 text-white shadow-md";
                    if(folderId === 'all') btn.className = "folder-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all bg-gray-800 text-white shadow-md";
                } else {
                    btn.className = "folder-btn whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all bg-white text-gray-500 border border-gray-200";
                }
            });
            const listContainer = document.getElementById('notes-list');
            listContainer.innerHTML = generateNotesListHTML();
        }

        function startEditNote(id) {
            state.editingNoteId = id;
            const note = state.notes.find(n => n.id === id);
            if(!note) return;

            document.getElementById('editor-title').innerText = "Editando Nota";
            document.getElementById('editor-save-btn').innerText = "Actualizar";
            document.getElementById('editor-cancel-btn').classList.remove('hidden');
            
            document.getElementById('new-note-text').value = note.text;
            if(note.image) {
                document.getElementById('image-preview').src = note.image;
                document.getElementById('image-preview-container').classList.remove('hidden');
            } else {
                clearImageInput();
            }

            document.getElementById('note-editor').classList.add('ring-2', 'ring-pink-100');
            document.getElementById('note-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function cancelEdit() {
            state.editingNoteId = null;
            document.getElementById('editor-title').innerText = "Nueva Nota";
            document.getElementById('editor-save-btn').innerText = "Guardar";
            document.getElementById('editor-cancel-btn').classList.add('hidden');
            document.getElementById('new-note-text').value = '';
            clearImageInput();
            document.getElementById('note-editor').classList.remove('ring-2', 'ring-pink-100');
        }

        async function saveNote() {
            const textInput = document.getElementById('new-note-text');
            const fileInput = document.getElementById('new-note-image');
            const imgPreview = document.getElementById('image-preview');
            const text = textInput.value.trim();
            const file = fileInput.files[0];

            if (!text && !file && imgPreview.classList.contains('hidden')) return showToast("Nota vac√≠a", "fa-pen");

            let imageData = null;
            if (file) {
                try { imageData = await processImage(file); } 
                catch (e) { return showToast("Error imagen", "fa-times"); }
            } else if (!document.getElementById('image-preview-container').classList.contains('hidden')) {
                imageData = imgPreview.src;
            }

            if (state.editingNoteId) {
                const noteIndex = state.notes.findIndex(n => n.id === state.editingNoteId);
                if (noteIndex > -1) {
                    state.notes[noteIndex].text = text;
                    state.notes[noteIndex].image = imageData;
                    const oldEl = document.getElementById(`note-${state.editingNoteId}`);
                    if(oldEl) {
                        const tempContainer = document.createElement('div');
                        tempContainer.innerHTML = createNoteHTML(state.notes[noteIndex]);
                        const newEl = tempContainer.firstElementChild;
                        newEl.classList.remove('item-enter');
                        newEl.classList.add('item-update'); 
                        oldEl.replaceWith(newEl);
                    }
                    showToast("Actualizada", "fa-check");
                }
                cancelEdit();
            } else {
                const targetFolder = state.currentFolderId === 'all' ? 'general' : state.currentFolderId;
                const newNote = { id: Date.now(), text, image: imageData, folderId: targetFolder };
                state.notes.unshift(newNote);
                if(state.currentFolderId === 'all' || state.currentFolderId === targetFolder) {
                    const list = document.getElementById('notes-list');
                    if(list.innerText.includes("Carpeta vac√≠a")) list.innerHTML = '';
                    list.insertAdjacentHTML('afterbegin', createNoteHTML(newNote));
                }
                textInput.value = '';
                clearImageInput();
                showToast("Guardada", "fa-check");
            }
            saveData();
        }

        function deleteNote(id) {
            state.notes = state.notes.filter(n => n.id !== id);
            if (state.editingNoteId === id) cancelEdit();
            saveData();
            
            const el = document.getElementById(`note-${id}`);
            if(el) { 
                el.classList.add('item-leave'); 
                setTimeout(() => el.remove(), 300); 
            }
            showToast("Eliminada", "fa-trash");
        }
        
        // Todo
        function getTodoHTML() {
            const todosHTML = state.todos.length === 0 
                ? `<div id="empty-todo" class="text-center py-10 opacity-60"><i class="fa-solid fa-clipboard-check text-4xl text-gray-300 mb-2"></i><p class="text-sm">Sin tareas pendientes</p></div>`
                : state.todos.sort((a,b) => a.done - b.done).map(t => createTodoItemHTML(t)).join('');

            return `
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1">Pendientes</h2>
                    <p class="text-sm text-gray-500 mb-6">Organiza tus tareas m√©dicas.</p>
                    <div class="flex gap-2 mb-6 shadow-sm rounded-xl">
                        <input type="text" id="new-todo" placeholder="Nueva tarea..." class="flex-1 p-4 rounded-l-xl border border-r-0 border-gray-200 focus:outline-none focus:ring-1 focus:ring-pink-500" onkeypress="if(event.key === 'Enter') addTodo()">
                        <button onclick="addTodo()" class="bg-pink-600 text-white px-5 rounded-r-xl hover:bg-pink-700 transition font-bold"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <ul id="todo-list" class="space-y-3 pb-20">${todosHTML}</ul>
                </div>
            `;
        }

        function createTodoItemHTML(todo) {
            const bg = todo.done ? 'bg-gray-50' : 'bg-white';
            const text = todo.done ? 'text-gray-400 line-through' : 'text-gray-700 font-medium';
            const border = todo.done ? 'border-gray-100' : 'border-gray-200';
            const icon = todo.done ? 'fa-regular fa-square-check text-gray-400' : 'fa-regular fa-square text-pink-500 hover:text-pink-600';
            return `<li id="todo-${todo.id}" class="flex items-center gap-3 p-4 rounded-xl shadow-sm border ${border} ${bg} transition-all group item-enter"><button onclick="toggleTodo(${todo.id})" class="text-xl focus:outline-none transform active:scale-90 transition-transform"><i id="icon-${todo.id}" class="${icon}"></i></button><span id="text-${todo.id}" class="flex-1 ${text} cursor-pointer select-none" onclick="toggleTodo(${todo.id})">${todo.text}</span><button onclick="confirmDelete('todo', ${todo.id})" class="text-gray-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100"><i class="fa-solid fa-trash-can"></i></button></li>`;
        }

        function addTodo() {
            const input = document.getElementById('new-todo');
            const text = input.value.trim();
            if (!text) return;
            const newTodo = { id: Date.now(), text, done: false };
            state.todos.unshift(newTodo);
            saveData();
            const list = document.getElementById('todo-list');
            const emptyMsg = document.getElementById('empty-todo');
            if(emptyMsg) emptyMsg.remove();
            list.insertAdjacentHTML('afterbegin', createTodoItemHTML(newTodo));
            input.value = '';
        }

        function toggleTodo(id) {
            const todo = state.todos.find(t => t.id === id);
            if (!todo) return;
            todo.done = !todo.done;
            saveData();
            const el = document.getElementById(`todo-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const text = document.getElementById(`text-${id}`);
            if (todo.done) {
                el.className = "flex items-center gap-3 p-4 rounded-xl shadow-sm border border-gray-100 bg-gray-50 transition-all group";
                icon.className = "fa-regular fa-square-check text-gray-400";
                text.className = "flex-1 text-gray-400 line-through cursor-pointer select-none";
            } else {
                el.className = "flex items-center gap-3 p-4 rounded-xl shadow-sm border border-gray-200 bg-white transition-all group";
                icon.className = "fa-regular fa-square text-pink-500 hover:text-pink-600";
                text.className = "flex-1 text-gray-700 font-medium cursor-pointer select-none";
            }
        }
        function deleteTodo(id) {
            state.todos = state.todos.filter(t => t.id !== id);
            saveData();
            const el = document.getElementById(`todo-${id}`);
            if (el) { el.classList.add('item-leave'); setTimeout(() => el.remove(), 300); }
            showToast("Tarea eliminada", "fa-trash");
        }

        // Links
        function getLinksHTML() {
            const linksHTML = state.links.map(l => createLinkHTML(l)).join('');
            return `<div><h2 class="text-2xl font-bold text-gray-800 mb-4">Links</h2><div class="bg-white p-5 rounded-xl shadow-sm mb-6 border border-gray-100 flex flex-col gap-3"><input type="text" id="link-title" placeholder="T√≠tulo" class="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:outline-none focus:ring-1 focus:ring-pink-500"><input type="url" id="link-url" placeholder="URL" class="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:outline-none focus:ring-1 focus:ring-pink-500"><button onclick="addLink()" class="bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 font-bold shadow-sm mt-1">A√±adir</button></div><div id="links-list" class="space-y-3 pb-20">${linksHTML}</div></div>`;
        }
        function createLinkHTML(link) {
            const favicon = `https://www.google.com/s2/favicons?domain=${link.url}&sz=64`;
            return `<div id="link-${link.id}" class="flex items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition item-enter"><img src="${favicon}" class="w-10 h-10 rounded-lg bg-gray-50 p-1 mr-3 object-contain border border-gray-100" onerror="this.src='https://via.placeholder.com/32'"><a href="${link.url}" target="_blank" class="flex-1 text-gray-700 font-bold truncate hover:text-pink-600 transition-colors">${link.title}<div class="text-[10px] text-gray-400 font-normal truncate">${link.url}</div></a><button onclick="confirmDelete('link', ${link.id})" class="text-gray-300 hover:text-red-500 ml-2 px-3 py-2 rounded-lg hover:bg-red-50 transition-colors"><i class="fa-solid fa-trash-can"></i></button></div>`;
        }
        function addLink() {
            const t = document.getElementById('link-title').value.trim();
            let u = document.getElementById('link-url').value.trim();
            if (!t || !u) return;
            if (!u.startsWith('http')) u = 'https://' + u;
            const newLink = { id: Date.now(), title: t, url: u };
            state.links.push(newLink);
            saveData();
            document.getElementById('links-list').insertAdjacentHTML('beforeend', createLinkHTML(newLink));
            document.getElementById('link-title').value = '';
            document.getElementById('link-url').value = '';
        }
        function deleteLink(id) {
            state.links = state.links.filter(l => l.id !== id);
            saveData();
            const el = document.getElementById(`link-${id}`);
            if(el) { el.classList.add('item-leave'); setTimeout(() => el.remove(), 300); }
        }

        // Utils
        function copyNote(id) {
            const note = state.notes.find(n => n.id === id);
            if(!note) return;
            const textarea = document.createElement('textarea');
            textarea.value = note.text;
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); showToast("Texto copiado", "fa-copy"); } catch (e) { showToast("Error al copiar", "fa-times"); }
            document.body.removeChild(textarea);
        }
        function openFolderModal() { document.body.classList.add('modal-open'); document.getElementById('folder-modal').classList.remove('hidden'); document.getElementById('new-folder-name').focus(); }
        function closeFolderModal() { document.body.classList.remove('modal-open'); document.getElementById('folder-modal').classList.add('hidden'); document.getElementById('new-folder-name').value = ''; }
        function createFolder() {
            const name = document.getElementById('new-folder-name').value.trim();
            if (!name) return;
            const id = 'f_' + Date.now();
            state.folders.push({ id, name });
            state.currentFolderId = id; 
            saveData();
            closeFolderModal();
            // Refresco manual de carpetas para no recargar todo
            document.getElementById('folders-container').innerHTML = generateFoldersHTML();
            changeFolder(id); // Activar la nueva
            showToast(`Carpeta "${name}" creada`, "fa-folder-plus");
        }
        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        function previewImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('image-preview'); if(img) { img.src = e.target.result; document.getElementById('image-preview-container').classList.remove('hidden'); } }; reader.readAsDataURL(input.files[0]); } }
        function clearImageInput() { document.getElementById('new-note-image').value = ''; document.getElementById('image-preview-container').classList.add('hidden'); document.getElementById('image-preview').src = ''; }

        // --- SISTEMA DE CONFIRMACI√ìN MODAL (GEN√âRICO) ---
        function showConfirmModal(title, message, actionBtnText, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const titleEl = modal.querySelector('h3');
            const msgEl = document.getElementById('confirm-message');
            const btn = document.getElementById('confirm-btn-action');

            titleEl.innerText = title;
            msgEl.innerText = message;
            btn.innerText = actionBtnText;
            
            // Importante: Asignar el nuevo handler
            btn.onclick = onConfirm;

            document.body.classList.add('modal-open');
            modal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        // Wrapper para compatibilidad con llamadas anteriores
        function confirmDelete(type, id) {
            let msg = "Esta acci√≥n no se puede deshacer.";
            if(type === 'todo') msg = "¬øBorrar esta tarea?";
            if(type === 'note') msg = "¬øBorrar esta nota?";
            if(type === 'link') msg = "¬øBorrar este enlace?";

            showConfirmModal("¬øEst√°s seguro?", msg, "Eliminar", function() {
                if (type === 'todo') deleteTodo(id);
                else if (type === 'note') deleteNote(id);
                else if (type === 'link') deleteLink(id);
                closeConfirmModal();
            });
        }

        init();
    </script>
</body>
</html>
