<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dra. Intermona</title>
    
    <!-- --- CONFIGURACIÓN DE ICONOS --- -->
    <link rel="icon" type="image/png" href="iconointermona.png">
    <link rel="shortcut icon" type="image/png" href="iconointermona.png">
    <link rel="apple-touch-icon" href="iconointermona.png"> 
    
    <!-- PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Intermona">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip para compresión de datos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- PDF.js para visualizar documentos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar worker de PDF.js
        window.addEventListener('load', function() {
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        });
    </script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        :root {
            --medical-pink: #ec4899;
            --medical-pink-light: #fce7f3;
            --medical-blue: #e0f2fe;
            --medical-white: #ffffff;
        }

        body {
            /* Fuente global a Patrick Hand (estilo notas) */
            font-family: 'Patrick Hand', cursive;
            background-color: #f8fafc; /* Gris muy suave, clínico */
            /* Patrón de papel milimetrado sutil */
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px),
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
            font-size: 1.1rem; 
        }
        
        /* Ajuste específico para inputs */
        input, textarea, button, select {
            font-family: 'Patrick Hand', cursive;
        }

        /* Estilo Receta Médica */
        .rx-paper {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #f3f4f6;
            position: relative;
        }
        .rx-paper::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: var(--medical-pink);
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        /* Animación ECG en el título */
        .ecg-line {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 20' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M0 10h10l5-8 5 16 5-8h25'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            animation: ecg-move 2s linear infinite;
        }
        @keyframes ecg-move {
            0% { opacity: 0.3; transform: translateX(-2px); }
            50% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0.3; transform: translateX(2px); }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animaciones */
        .fade-enter { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .item-enter { animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Botones estilo píldora */
        .btn-pill {
            border-radius: 9999px;
            transition: all 0.2s;
        }
        .btn-pill:active { transform: scale(0.95); }

        .item-leave {
            transition: all 0.3s ease-in;
            opacity: 0; transform: scale(0.9); height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden;
        }
        
        .badge-clip {
            clip-path: polygon(0% 0%, 100% 0%, 100% 85%, 50% 100%, 0% 85%);
        }

        /* Ajustes Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="text-slate-600 h-screen flex flex-col overflow-hidden">

    <!-- Header Clínico -->
    <header class="bg-pink-500 text-white pt-safe shadow-lg z-20 shrink-0 relative overflow-hidden">
        <!-- Decoración de fondo del header -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(white 1px, transparent 1px); background-size: 10px 10px;"></div>
        
        <div class="p-4 flex justify-between items-center relative z-10">
            <div class="flex items-center gap-3 cursor-pointer" onclick="renderView('dashboard')">
                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm border border-white/30">
                    <i class="fa-solid fa-user-md text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-wide flex items-center gap-2">
                        Dra. Intermona <span class="ecg-line"></span>
                    </h1>
                    <p class="text-xs text-pink-100 uppercase tracking-widest font-bold">Sistema Médico Personal</p>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- BOTÓN CONTACTO (INSTAGRAM) -->
                <button onclick="window.open('https://www.instagram.com/tomaccou?igsh=MW5vNm12Y2I1NGQ1dA%3D%3D&utm_source=qr', '_blank')" class="text-sm bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-full backdrop-blur-md transition shadow-sm border border-white/20 active:scale-95 flex items-center gap-1.5">
                    <i class="fa-brands fa-instagram"></i> <span class="hidden sm:inline">Contacto</span>
                </button>
                <button onclick="openBackupModal()" class="text-sm bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-full backdrop-blur-md transition shadow-sm border border-white/20 active:scale-95 flex items-center gap-1.5">
                    <i class="fa-solid fa-database"></i> <span class="hidden sm:inline">Datos</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-28 relative scroll-smooth hide-scrollbar"></main>

    <!-- Nav Bar Flotante (Estilo Instrumental) -->
    <div class="fixed bottom-0 w-full z-30 pb-safe pointer-events-none">
        <nav class="bg-white mx-4 mb-4 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-gray-100 p-2 pointer-events-auto flex justify-around items-center">
            <button onclick="renderView('dashboard')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="dashboard">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-hospital-user text-2xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[11px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase tracking-wide">Inicio</span>
            </button>
            <button onclick="renderView('todo')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="todo">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-clipboard-check text-2xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[11px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase tracking-wide">Ronda</span>
            </button>
            <button onclick="renderView('turnario')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="turnario">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-calendar-heart text-2xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[11px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase tracking-wide">Calendario</span>
            </button>
            <button onclick="renderView('notes')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="notes">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-file-prescription text-2xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[11px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase tracking-wide">Notas</span>
            </button>
            <button onclick="renderView('links')" class="nav-btn group relative p-2 w-full flex flex-col items-center gap-1 rounded-xl hover:bg-pink-50 transition-colors" data-target="links">
                <div class="w-1 h-1 bg-pink-500 rounded-full opacity-0 group-[.active]:opacity-100 absolute top-1 transition-opacity"></div>
                <i class="fa-solid fa-book-medical text-2xl mb-0.5 text-gray-400 group-[.active]:text-pink-500 transition-colors"></i>
                <span class="text-[11px] font-bold text-gray-400 group-[.active]:text-pink-600 uppercase tracking-wide">Info</span>
            </button>
        </nav>
    </div>

    <!-- Modal Turnario -->
    <div id="shift-modal" class="hidden fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-0 overflow-hidden transform transition-all scale-100 border-t-4 border-pink-500">
            <div class="bg-pink-50 p-4 border-b border-pink-100 flex justify-between items-center">
                <h3 id="modal-date-title" class="text-xl font-bold text-pink-700">Editar Fecha</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white text-pink-400 flex items-center justify-center hover:bg-pink-100 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <label class="block text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-stethoscope"></i> Tipo de Asignación:</label>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="setShiftType('guardia')" data-type="guardia" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-red-400 hover:text-red-500 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-user-doctor text-xl"></i> Paso</button>
                    <button onclick="setShiftType('dia')" data-type="dia" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-blue-400 hover:text-blue-500 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-sun text-xl"></i> Turno Día</button>
                    <button onclick="setShiftType('noche')" data-type="noche" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-indigo-400 hover:text-indigo-500 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-moon text-xl"></i> Turno Noche</button>
                    <button onclick="setShiftType('post')" data-type="post" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-orange-400 hover:text-orange-500 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-book-open text-xl"></i> Día de Estudio</button>
                    <button onclick="setShiftType('libre')" data-type="libre" class="shift-type-btn p-3 rounded-xl bg-white border border-slate-200 text-slate-500 hover:border-green-400 hover:text-green-500 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-mug-hot text-xl"></i> Libre</button>
                    <button onclick="setShiftType(null)" data-type="null" class="shift-type-btn p-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-400 hover:bg-slate-100 hover:text-slate-600 font-bold text-sm transition-all flex flex-col items-center gap-2 shadow-sm"><i class="fa-solid fa-eraser text-xl"></i> Ninguno</button>
                </div>
                <div class="space-y-4">
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center gap-3"><i class="fa-regular fa-clock text-slate-400"></i><input type="time" id="modal-event-time" class="bg-transparent w-full text-lg font-bold text-slate-700 focus:outline-none"></div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center gap-3"><i class="fa-solid fa-pen-to-square text-slate-400"></i><input type="text" id="modal-note-input" class="bg-transparent w-full text-lg font-semibold text-slate-700 focus:outline-none placeholder-slate-400" placeholder="Anotación clínica / Evento..."></div>
                </div>
                <div class="flex justify-between items-center mt-6 gap-3">
                    <button onclick="deleteCurrentShift()" class="px-4 py-3 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-xl font-bold text-lg transition-colors" title="Borrar todo el evento"><i class="fa-solid fa-trash-can"></i></button>
                    <button onclick="saveShift()" class="flex-1 py-3 bg-pink-500 text-white rounded-xl hover:bg-pink-600 shadow-lg shadow-pink-200 transform active:scale-95 transition-all font-bold tracking-wide text-lg"><i class="fa-solid fa-floppy-disk mr-2"></i> Guardar Ficha</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmación (Z-INDEX 70) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900/50 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6 text-center">
            <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-red-100"><i class="fa-solid fa-triangle-exclamation text-xl"></i></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">¿Confirmar acción?</h3>
            <p id="confirm-message" class="text-lg text-slate-500 mb-6">Esta acción es irreversible.</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeConfirmModal()" class="px-5 py-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 font-bold text-lg">Cancelar</button>
                <button id="confirm-btn-action" class="px-5 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 font-bold text-lg shadow-md shadow-red-200">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Carpeta -->
    <div id="folder-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-folder-plus text-pink-500"></i> Nueva Categoría</h3>
            <input type="text" id="new-folder-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-pink-500 outline-none text-lg font-semibold" placeholder="Ej: Cardiología, Pediatría...">
            <div class="flex justify-end gap-3">
                <button onclick="closeFolderModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-lg">Cancelar</button>
                <button onclick="createFolder()" class="px-4 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 font-bold text-lg shadow-lg shadow-pink-200">Crear</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Nombre -->
    <div id="name-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-id-card text-pink-500"></i> Editar Nombre</h3>
            <p class="text-sm text-slate-400 mb-3">¿Cómo quieres que te llame la app?</p>
            <input type="text" id="new-user-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-pink-500 outline-none text-lg font-semibold text-slate-700" placeholder="Ej: Dra. García">
            <div class="flex justify-end gap-3">
                <button onclick="closeNameModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-lg">Cancelar</button>
                <button onclick="saveName()" class="px-4 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 font-bold text-lg shadow-lg shadow-pink-200">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Paciente -->
    <div id="patient-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 border-t-4 border-blue-400">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-user-injured text-blue-500"></i> Ingresar Paciente</h3>
            <div class="space-y-3">
                <input type="text" id="patient-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-lg font-semibold" placeholder="Nombre del Paciente">
                <div class="flex gap-3">
                    <input type="text" id="patient-room" class="w-1/3 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-lg font-semibold" placeholder="Cama/Hab">
                    <input type="text" id="patient-dx" class="w-2/3 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-400 outline-none text-lg font-semibold" placeholder="Diagnóstico (Breve)">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closePatientModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-lg">Cancelar</button>
                <button onclick="createPatient()" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 font-bold text-lg shadow-lg shadow-blue-200">Ingresar</button>
            </div>
        </div>
    </div>

    <!-- Modal Backup -->
    <div id="backup-modal" class="hidden fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-database text-pink-500"></i> Gestión de Datos</h3>
            <p class="text-sm text-slate-500 mb-6">Guarda una copia comprimida de tus registros (incluyendo imágenes) o restaura una anterior.</p>
            <div class="grid gap-3">
                <button onclick="downloadBackupFile()" class="p-4 rounded-xl border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition flex items-center gap-3 group">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-file-zipper"></i></div>
                    <div class="text-left"><h4 class="font-bold text-slate-700 text-lg">Descargar Backup ZIP</h4><p class="text-xs text-slate-400">Archivo comprimido completo</p></div>
                </button>
                <label class="p-4 rounded-xl border border-slate-200 hover:border-green-400 hover:bg-green-50 transition flex items-center gap-3 group cursor-pointer relative">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-upload"></i></div>
                    <div class="text-left"><h4 class="font-bold text-slate-700 text-lg">Restaurar Backup ZIP</h4><p class="text-xs text-slate-400">Cargar archivo .zip</p></div>
                    <input type="file" id="backup-file-input" accept=".zip" class="hidden" onchange="importBackupFromFile(this)">
                </label>
                <button onclick="exportDataToClipboard()" class="p-4 rounded-xl border border-slate-200 hover:border-purple-400 hover:bg-purple-50 transition flex items-center gap-3 group">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-regular fa-copy"></i></div>
                    <div class="text-left"><h4 class="font-bold text-slate-700 text-lg">Copiar JSON (Solo Texto)</h4><p class="text-xs text-slate-400">Portapapeles (sin imágenes pesadas)</p></div>
                </button>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeBackupModal()" class="px-4 py-2 text-slate-400 hover:text-slate-600 font-bold text-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Lector de PDF (REEMPLAZADO IFRAME POR PDF.JS) -->
    <div id="pdf-reader-modal" class="hidden fixed inset-0 bg-slate-900 z-[90] flex flex-col animate-fade-in">
        <div class="bg-slate-800 text-white p-4 flex justify-between items-center shadow-lg shrink-0 z-20">
            <h3 id="pdf-reader-title" class="text-lg font-bold truncate max-w-[60%]"><i class="fa-solid fa-file-pdf mr-2 text-red-400"></i> Documento</h3>
            <div class="flex gap-2">
                <button onclick="closePdfReader()" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-red-500 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        
        <!-- Barra de Navegación -->
        <div class="bg-slate-700 text-white p-2 flex justify-center items-center gap-3 shadow-md shrink-0 z-10">
            <button onclick="changePdfPage(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-600 rounded hover:bg-slate-500 transition" title="Anterior (Flecha Izquierda)"><i class="fa-solid fa-chevron-left"></i></button>
            <div class="flex items-center gap-2 text-sm font-bold">
                <span>Pág</span>
                <input type="number" id="pdf-page-num" class="w-12 bg-slate-600 border border-slate-500 rounded text-center text-white focus:outline-none focus:border-pink-500 font-bold" value="1" min="1" onchange="jumpToPdfPage(this.value)">
                <span class="text-slate-400">de <span id="pdf-page-count">--</span></span>
            </div>
            <button onclick="changePdfPage(1)" class="w-8 h-8 flex items-center justify-center bg-slate-600 rounded hover:bg-slate-500 transition" title="Siguiente (Flecha Derecha)"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="flex-1 bg-slate-200 relative overflow-y-auto overflow-x-hidden flex justify-center p-4" id="pdf-scroll-container">
            <canvas id="the-canvas" class="shadow-lg max-w-full h-auto"></canvas>
            <div id="pdf-loader" class="absolute inset-0 flex items-center justify-center bg-white z-10 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-all duration-300 pointer-events-none z-[80] flex items-center gap-3 text-lg font-bold translate-y-4">
        <div class="w-6 h-6 bg-pink-500 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-check"></i></div>
        <span id="toast-msg">Notificación</span>
    </div>

    <script>
        const APP_KEY = 'intermona_data_v2'; 
        let state = {
            view: 'dashboard', 
            todos: [],
            notes: [],
            folders: [],
            links: [],
            pdfs: [], 
            shifts: {},
            patients: [],
            userProfileImage: null, 
            userName: 'Dra.', 
            currentDate: new Date(),
            currentFolderId: 'all',
            editingNoteId: null,
            activeInfoTab: 'web'
        };
        let selectedDateKey = null; 
        let tempShiftType = null;
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;

        // --- PDF SWIPE NAVIGATION (TOUCH) ---
        let touchStartX = 0;
        let touchEndX = 0;

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
        }

        function handleTouchEnd(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipeGesture();
        }

        function handleSwipeGesture() {
            const swipeThreshold = 50; 
            if (touchEndX < touchStartX - swipeThreshold) {
                onNextPage();
            }
            if (touchEndX > touchStartX + swipeThreshold) {
                onPrevPage();
            }
        }

        // --- SISTEMA DE ALMACENAMIENTO LOCAL (SIN LIBRERÍAS EXTERNAS) ---
        const idbKeyval = {
            async get(key) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('intermona-db', 1);
                    request.onupgradeneeded = () => request.result.createObjectStore('store');
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        const db = request.result;
                        const tx = db.transaction('store', 'readonly');
                        const store = tx.objectStore('store');
                        const req = store.get(key);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject(req.error);
                    };
                });
            },
            async set(key, val) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('intermona-db', 1);
                    request.onupgradeneeded = () => request.result.createObjectStore('store');
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        const db = request.result;
                        const tx = db.transaction('store', 'readwrite');
                        const store = tx.objectStore('store');
                        const req = store.put(val, key);
                        req.onsuccess = () => resolve();
                        req.onerror = () => reject(req.error);
                    };
                });
            }
        };

        async function init() {
            try {
                await loadData();
                state.view = null; 
                renderView('dashboard');
                const oldData = localStorage.getItem(APP_KEY);
                if (oldData) {
                    const parsed = JSON.parse(oldData);
                    await idbKeyval.set(APP_KEY, parsed);
                }
                
                // Add Touch Listeners for PDF Swipe
                const pdfContainer = document.getElementById('pdf-scroll-container');
                if(pdfContainer) {
                    pdfContainer.addEventListener('touchstart', handleTouchStart, {passive: true});
                    pdfContainer.addEventListener('touchend', handleTouchEnd, {passive: true});
                }

            } catch (e) {
                console.error("Error iniciando app:", e);
            }
        }

        async function loadData() {
            try {
                let saved = await idbKeyval.get(APP_KEY);
                if (!saved) {
                    const localSaved = localStorage.getItem(APP_KEY);
                    if (localSaved) saved = JSON.parse(localSaved);
                }
                if (saved) {
                    if (!saved.todos) saved.todos = [];
                    if (!saved.notes) saved.notes = [];
                    if (!saved.links) saved.links = [];
                    if (!saved.pdfs) saved.pdfs = []; 
                    if (!saved.folders) saved.folders = [{id: 'general', name: 'General'}];
                    if (!saved.patients) saved.patients = []; 
                    if (!saved.userName) saved.userName = 'Dra.'; 
                    state = { ...state, ...saved, currentDate: new Date() }; 
                } else {
                    state.folders = [{id: 'general', name: 'General'}];
                    state.todos = [{ id: 1, text: "Bienvenida Dra. Intermona", done: false }];
                }
                if (!state.folders || state.folders.length === 0) state.folders = [{id: 'general', name: 'General'}];
            } catch (e) { 
                console.error("Error cargando datos:", e);
                state.folders = [{id: 'general', name: 'General'}];
            }
        }

        async function saveData() {
            const toSave = { ...state };
            delete toSave.currentDate; 
            delete toSave.editingNoteId; 
            try {
                await idbKeyval.set(APP_KEY, toSave);
            } catch (e) {
                console.error("Error guardando en BD:", e);
                showToast("Error al guardar", "fa-triangle-exclamation");
            }
        }

        // --- PDF KEYBOARD NAVIGATION ---
        function handlePdfKeyDown(e) {
            if (document.getElementById('pdf-reader-modal').classList.contains('hidden')) return;
            if (e.key === 'ArrowLeft') { onPrevPage(); e.preventDefault(); } 
            else if (e.key === 'ArrowRight') { onNextPage(); e.preventDefault(); }
        }

        // --- PDF RENDER LOGIC (DOBLE BUFFER PARA CERO FLICKER) ---
        function renderPage(num) {
            pageRendering = true;
            // No mostrar loader para evitar parpadeo blanco entre paginas
            
            pdfDoc.getPage(num).then(function(page) {
                const container = document.getElementById('pdf-scroll-container');
                
                // 1. Crear canvas en memoria (buffer invisible)
                const newCanvas = document.createElement('canvas');
                newCanvas.id = "the-canvas"; 
                newCanvas.className = "shadow-lg max-w-full h-auto";
                const ctx = newCanvas.getContext('2d');
                
                const viewportTest = page.getViewport({scale: 1.0});
                const desiredWidth = Math.min(container.clientWidth * 0.95, 1000);
                const scale = desiredWidth / viewportTest.width;
                const viewport = page.getViewport({scale: scale});

                newCanvas.height = viewport.height;
                newCanvas.width = viewport.width;
                newCanvas.style.width = '100%';
                newCanvas.style.maxWidth = '800px';
                newCanvas.style.height = 'auto';

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);

                renderTask.promise.then(function() {
                    // 2. Intercambio Atómico: Solo cuando el nuevo está listo, lo ponemos en el DOM
                    const oldCanvas = document.getElementById('the-canvas');
                    if (oldCanvas && oldCanvas.parentNode === container) {
                        container.replaceChild(newCanvas, oldCanvas);
                    } else {
                        // Si es la primera vez
                        const loader = document.getElementById('pdf-loader');
                        container.insertBefore(newCanvas, loader); 
                    }
                    
                    pageRendering = false;
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('pdf-page-num').value = num;
        }

        function queueRenderPage(num) {
            if (pageRendering) { pageNumPending = num; } else { renderPage(num); }
        }
        function onPrevPage() { if (pageNum <= 1) return; pageNum--; queueRenderPage(pageNum); }
        function onNextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); }
        function changePdfPage(delta) { if (delta === -1) onPrevPage(); if (delta === 1) onNextPage(); }
        function jumpToPdfPage(numVal) {
            const num = parseInt(numVal);
            if (num >= 1 && num <= pdfDoc.numPages) { pageNum = num; queueRenderPage(pageNum); } else { document.getElementById('pdf-page-num').value = pageNum; }
        }

        async function openPdfReader(id) {
            const pdf = state.pdfs.find(p => p.id === id);
            if(!pdf) return;
            const modal = document.getElementById('pdf-reader-modal');
            const title = document.getElementById('pdf-reader-title');
            const loader = document.getElementById('pdf-loader');
            
            // Limpiar visualmente para inicio fresco
            const oldCanvas = document.getElementById('the-canvas');
            if(oldCanvas) {
                const ctx = oldCanvas.getContext('2d');
                ctx.clearRect(0,0, oldCanvas.width, oldCanvas.height);
            }

            title.innerHTML = `<i class="fa-solid fa-file-pdf mr-2 text-red-400"></i> ${pdf.title}`;
            loader.classList.remove('hidden'); // Mostrar loader solo al abrir
            modal.classList.remove('hidden');
            
            document.addEventListener('keydown', handlePdfKeyDown);

            try {
                const loadingTask = pdfjsLib.getDocument(pdf.data);
                pdfDoc = await loadingTask.promise;
                document.getElementById('pdf-page-count').textContent = pdfDoc.numPages;
                pageNum = 1;
                renderPage(pageNum);
                
                // Ocultar loader inicial despues del primer render
                // El renderPage ya maneja la visualización, pero aseguramos ocultar loader inicial
                setTimeout(() => loader.classList.add('hidden'), 500);
            } catch (error) {
                console.error("Error renderizando PDF:", error);
                showToast("Error al abrir PDF", "fa-bug");
                closePdfReader();
            }
        }

        function closePdfReader() {
            document.getElementById('pdf-reader-modal').classList.add('hidden');
            document.removeEventListener('keydown', handlePdfKeyDown);
            pdfDoc = null;
            pageNum = 1;
            pageRendering = false;
            pageNumPending = null;
        }

        // ... (RESTO DE FUNCIONES UI: Toast, Imagenes, Modales, etc.) ...
        function showToast(msg, icon = 'fa-info-circle') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.querySelector('div').innerHTML = `<i class="fa-solid ${icon}"></i>`;
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                toast.classList.remove('translate-y-0');
            }, 3000);
        }

        async function updateProfileImage(input) {
            if (input.files && input.files[0]) {
                try {
                    const base64 = await processImage(input.files[0]);
                    state.userProfileImage = base64;
                    saveData();
                    renderView('dashboard');
                    showToast("Foto actualizada", "fa-camera");
                } catch (e) { showToast("Error al procesar imagen", "fa-triangle-exclamation"); }
            }
        }

        function openNameModal() { document.getElementById('new-user-name').value = state.userName || ''; document.body.classList.add('modal-open'); document.getElementById('name-modal').classList.remove('hidden'); document.getElementById('new-user-name').focus(); }
        function closeNameModal() { document.body.classList.remove('modal-open'); document.getElementById('name-modal').classList.add('hidden'); }
        function saveName() { const name = document.getElementById('new-user-name').value.trim(); if (name) { state.userName = name; saveData(); renderView('dashboard'); closeNameModal(); showToast("Nombre actualizado", "fa-id-card"); } }

        function openBackupModal() { document.getElementById('backup-modal').classList.remove('hidden'); }
        function closeBackupModal() { document.getElementById('backup-modal').classList.add('hidden'); document.getElementById('backup-file-input').value = ''; }
        
        async function downloadBackupFile() {
            try {
                showToast("Preparando ZIP...", "fa-spinner fa-spin");
                const zip = new JSZip();
                const dataStr = JSON.stringify(state, null, 2);
                zip.file("intermona_data.json", dataStr);
                const content = await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 9 } });
                const downloadAnchorNode = document.createElement('a');
                const fileName = "intermona_backup_" + new Date().toISOString().slice(0,10) + ".zip";
                downloadAnchorNode.href = URL.createObjectURL(content);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                document.body.removeChild(downloadAnchorNode);
                URL.revokeObjectURL(downloadAnchorNode.href);
                showToast("Backup ZIP Descargado", "fa-file-zipper");
            } catch (err) { showToast("Error al comprimir", "fa-triangle-exclamation"); }
        }

        async function importBackupFromFile(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                showToast("Analizando ZIP...", "fa-spinner fa-spin");
                const zip = await JSZip.loadAsync(file);
                const dataFile = zip.file("intermona_data.json");
                if (!dataFile) throw new Error("El archivo ZIP no contiene datos válidos de Intermona.");
                const content = await dataFile.async("string");
                const data = JSON.parse(content);
                if (data && (data.todos || data.notes || data.shifts)) {
                    showConfirmModal("Restaurar desde ZIP", "Se reemplazará toda la información actual.", "Restaurar", function() {
                        state = { ...state, ...data, currentDate: new Date() };
                        saveData();
                        closeConfirmModal();
                        closeBackupModal();
                        state.view = null;
                        renderView('dashboard');
                        showToast("Datos restaurados", "fa-check-double");
                    });
                } else { showToast("Datos corruptos", "fa-triangle-exclamation"); }
            } catch (err) { showToast("Error: Archivo inválido", "fa-bug"); }
            input.value = ''; 
        }

        function exportDataToClipboard() { const textArea = document.createElement("textarea"); textArea.value = JSON.stringify(state); textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.select(); try { if(document.execCommand('copy')) showToast("JSON copiado", "fa-clipboard-check"); else showToast("Error al copiar", "fa-times"); } catch (err) { showToast("Error al copiar", "fa-times"); } document.body.removeChild(textArea); }

        function setInfoTab(tab) {
            state.activeInfoTab = tab;
            const webBtn = document.getElementById('tab-btn-web');
            const pdfBtn = document.getElementById('tab-btn-pdf');
            const webContent = document.getElementById('tab-content-web');
            const pdfContent = document.getElementById('tab-content-pdf');

            if (webBtn && pdfBtn && webContent && pdfContent) {
                if (tab === 'web') {
                    webContent.classList.remove('hidden');
                    pdfContent.classList.add('hidden');
                    webBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition bg-white text-pink-600 shadow-sm';
                    pdfBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition text-slate-500 hover:text-slate-700';
                } else {
                    webContent.classList.add('hidden');
                    pdfContent.classList.remove('hidden');
                    webBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition text-slate-500 hover:text-slate-700';
                    pdfBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition bg-white text-pink-600 shadow-sm';
                }
            } else {
                renderView('links');
            }
        }

        function triggerPdfInput() {
            document.getElementById('pdf-input-file').click();
        }

        async function handlePdfUpload(input) {
            const file = input.files[0];
            if(!file) return;
            
            // --- NUEVO LÍMITE: 25MB (Aumentado de 2.5MB) ---
            if(file.size > 25 * 1024 * 1024) {
                showToast("Archivo muy grande (Máx 25MB)", "fa-triangle-exclamation");
                input.value = '';
                return;
            }

            try {
                showToast("Procesando archivo...", "fa-spinner fa-spin");
                const base64 = await processFileBase64(file);
                const newPdf = { id: Date.now(), title: file.name.replace('.pdf', ''), data: base64 };
                if(!state.pdfs) state.pdfs = [];
                state.pdfs.push(newPdf);
                await saveData(); 
                renderView('links');
                showToast("PDF Agregado", "fa-file-pdf");
            } catch(e) {
                console.error(e); 
                showToast("Error al leer archivo", "fa-times"); 
            }
            input.value = '';
        }

        function processFileBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function deletePdf(id) {
            showConfirmModal("¿Eliminar PDF?", "Esta acción no se puede deshacer.", "Eliminar", () => {
                state.pdfs = state.pdfs.filter(p => p.id !== id);
                saveData();
                closeConfirmModal();
                renderView('links');
                showToast("PDF eliminado", "fa-trash");
            });
        }

        function getLinksHTML() {
            const isWeb = state.activeInfoTab === 'web';
            const linksHTML = (state.links || []).map(l => createLinkHTML(l)).join('');
            const webContent = `
                <div class="flex flex-col lg:flex-row gap-6 fade-enter">
                    <div class="lg:w-1/3 shrink-0">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 sticky top-0">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3">Nuevo Enlace</h3>
                            <div class="flex flex-col gap-3">
                                <input type="text" id="link-title" placeholder="Nombre del recurso" class="p-3 bg-slate-50 rounded-xl text-lg outline-none border border-transparent focus:bg-white focus:border-pink-300 transition w-full">
                                <div class="flex flex-col gap-2">
                                    <input type="url" id="link-url" placeholder="https://..." class="p-3 bg-slate-50 rounded-xl text-lg outline-none border border-transparent focus:bg-white focus:border-pink-300 transition w-full">
                                    <button onclick="addLink()" class="bg-slate-800 text-white px-4 py-3 rounded-xl font-bold hover:bg-slate-700 transition shadow-lg shadow-slate-200 text-lg w-full mt-1">
                                        <i class="fa-solid fa-plus mr-2"></i> Guardar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:w-2/3">
                        <h3 class="hidden lg:block text-sm font-bold text-slate-400 uppercase tracking-widest mb-3">Biblioteca Guardada</h3>
                        <div id="links-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3 pb-20">
                            ${linksHTML || '<div class="text-center opacity-40 py-10 col-span-full">Sin enlaces web guardados</div>'}
                        </div>
                    </div>
                </div>`;
            const pdfsHTML = (state.pdfs || []).map(p => createPdfHTML(p)).join('');
            const pdfContent = `
                <div class="flex flex-col lg:flex-row gap-6 fade-enter">
                    <div class="lg:w-1/3 shrink-0">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 sticky top-0 text-center">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 text-left">Subir Documento</h3>
                            <div class="border-2 border-dashed border-slate-200 rounded-xl p-8 hover:bg-slate-50 transition cursor-pointer group flex flex-col items-center justify-center gap-2 h-64" onclick="triggerPdfInput()">
                                <div class="w-16 h-16 rounded-full bg-slate-50 group-hover:bg-pink-50 flex items-center justify-center transition mb-2">
                                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 group-hover:text-pink-400 transition"></i>
                                </div>
                                <p class="text-lg font-bold text-slate-500 group-hover:text-pink-500 transition">Toca para subir</p>
                                <p class="text-xs text-slate-400">PDF (Máx 25MB)</p>
                                <input type="file" id="pdf-input-file" accept="application/pdf" class="hidden" onchange="handlePdfUpload(this)">
                            </div>
                        </div>
                    </div>
                    <div class="lg:w-2/3">
                        <h3 class="hidden lg:block text-sm font-bold text-slate-400 uppercase tracking-widest mb-3">Documentos Guardados</h3>
                        <div id="pdfs-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3 pb-20">
                            ${pdfsHTML || '<div class="text-center opacity-40 py-10 col-span-full">Sin documentos guardados</div>'}
                        </div>
                    </div>
                </div>`;
            return `<div>
                    <h2 class="text-3xl font-black text-slate-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-book-medical text-pink-500"></i> Biblioteca & Info</h2>
                    <div class="flex p-1 bg-slate-200 rounded-xl mb-4">
                        <button id="tab-btn-web" onclick="setInfoTab('web')" class="flex-1 py-2 text-sm font-bold rounded-lg transition ${isWeb ? 'bg-white text-pink-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Enlaces Web</button>
                        <button id="tab-btn-pdf" onclick="setInfoTab('pdf')" class="flex-1 py-2 text-sm font-bold rounded-lg transition ${!isWeb ? 'bg-white text-pink-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Documentos PDF</button>
                    </div>
                    <div id="tab-content-web" class="${isWeb ? '' : 'hidden'}">${webContent}</div>
                    <div id="tab-content-pdf" class="${!isWeb ? '' : 'hidden'}">${pdfContent}</div>
                </div>`;
        }

        function createPdfHTML(pdf) {
            return `<div class="flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition hover:border-red-100 group cursor-pointer h-full" onclick="openPdfReader(${pdf.id})"><div class="w-12 h-12 rounded-lg bg-red-50 text-red-500 flex items-center justify-center mr-4 text-2xl group-hover:scale-110 transition"><i class="fa-solid fa-file-pdf"></i></div><div class="flex-1 min-w-0"><h4 class="text-slate-700 font-bold truncate text-lg">${pdf.title}</h4><p class="text-xs text-slate-400">Toca para leer</p></div><button onclick="event.stopPropagation(); deletePdf(${pdf.id})" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash-can text-lg"></i></button></div>`;
        }

        function createLinkHTML(link) {
            const favicon = `https://www.google.com/s2/favicons?domain=${link.url}&sz=64`;
            return `<div id="link-${link.id}" class="flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition hover:border-pink-100 group h-full"><img src="${favicon}" class="w-10 h-10 rounded-lg bg-slate-50 p-1.5 mr-4 object-contain" onerror="this.src='https://via.placeholder.com/32'"><a href="${link.url}" target="_blank" class="flex-1 text-slate-700 font-bold hover:text-pink-600 transition truncate pr-4"><span class="text-lg">${link.title}</span><div class="text-xs text-slate-400 font-normal truncate mt-0.5">${link.url}</div></a><button onclick="confirmDelete('link', ${link.id})" class="w-10 h-10 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash-can text-lg"></i></button></div>`;
        }
        function addLink() {
            const t = document.getElementById('link-title').value.trim();
            let u = document.getElementById('link-url').value.trim();
            if (!t || !u) return;
            if (!u.startsWith('http')) u = 'https://' + u;
            const newLink = { id: Date.now(), title: t, url: u };
            state.links.push(newLink);
            saveData();
            renderView('links'); 
            showToast("Recurso añadido", "fa-bookmark");
        }
        function deleteLink(id) {
            state.links = state.links.filter(l => l.id !== id);
            saveData();
            renderView('links');
        }

        function openFolderModal() { document.body.classList.add('modal-open'); document.getElementById('folder-modal').classList.remove('hidden'); document.getElementById('new-folder-name').focus(); }
        function closeFolderModal() { document.body.classList.remove('modal-open'); document.getElementById('folder-modal').classList.add('hidden'); document.getElementById('new-folder-name').value = ''; }
        function createFolder() {
            const name = document.getElementById('new-folder-name').value.trim();
            if (!name) return;
            const id = 'f_' + Date.now();
            state.folders.push({ id, name });
            state.currentFolderId = id; 
            saveData();
            closeFolderModal();
            changeFolder(id); 
            showToast(`Categoría "${name}" creada`, "fa-folder-plus");
        }
        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800;
                        let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        function previewImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('image-preview'); if(img) { img.src = e.target.result; document.getElementById('image-preview-container').classList.remove('hidden'); } }; reader.readAsDataURL(input.files[0]); } }
        function clearImageInput() { document.getElementById('new-note-image').value = ''; document.getElementById('image-preview-container').classList.add('hidden'); document.getElementById('image-preview').src = ''; }

        function showConfirmModal(title, message, actionBtnText, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('h3').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            const btn = document.getElementById('confirm-btn-action');
            btn.innerText = actionBtnText;
            btn.onclick = onConfirm;
            document.body.classList.add('modal-open');
            modal.classList.remove('hidden');
        }
        function closeConfirmModal() { document.body.classList.remove('modal-open'); document.getElementById('confirm-modal').classList.add('hidden'); }
        function confirmDelete(type, id) {
            let msg = "Esta acción es definitiva.";
            if(type === 'todo') msg = "¿Completar o borrar esta tarea?";
            if(type === 'note') msg = "¿Eliminar este registro clínico?";
            if(type === 'link') msg = "¿Eliminar este recurso?";

            showConfirmModal("¿Estás segura?", msg, "Eliminar", function() {
                if (type === 'todo') deleteTodo(id);
                else if (type === 'note') deleteNote(id);
                else if (type === 'link') deleteLink(id);
                closeConfirmModal();
            });
        }

        // --- DASHBOARD FUNCTIONS ---
        function getDashboardHTML() {
            const today = new Date();
            const dateKey = today.toISOString().split('T')[0];
            let shift = state.shifts[dateKey];
            let isNextShift = false;
            let nextDateStr = "";
            if (!shift) {
                const futureDates = Object.keys(state.shifts).filter(date => date > dateKey).sort();
                if (futureDates.length > 0) {
                    const nextDateKey = futureDates[0];
                    shift = state.shifts[nextDateKey];
                    isNextShift = true;
                    const [y, m, d] = nextDateKey.split('-').map(Number);
                    nextDateStr = new Date(y, m - 1, d).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
                }
            }
            let nextEvent = null;
            const sortedDates = Object.keys(state.shifts).sort();
            for (const d of sortedDates) {
                if (d >= dateKey && state.shifts[d].eventTime && state.shifts[d].note) {
                    nextEvent = { date: d, ...state.shifts[d] };
                    break; 
                }
            }
            let reminderHTML = '';
            if (nextEvent) {
                const [y, m, d] = nextEvent.date.split('-').map(Number);
                const isTodayEvent = nextEvent.date === dateKey;
                const eventDateStr = new Date(y, m - 1, d).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
                reminderHTML = `<div class="order-3 bg-gradient-to-r from-indigo-500 to-blue-500 text-white p-4 rounded-2xl shadow-lg shadow-indigo-200 flex items-center gap-4 relative overflow-hidden shrink-0"><div class="bg-white/20 p-3 rounded-xl backdrop-blur-sm"><i class="fa-solid fa-bell text-2xl"></i></div><div class="flex-1 z-10"><p class="text-xs uppercase tracking-wider opacity-80 font-bold">Recordatorio</p><h4 class="font-bold text-xl leading-tight">${nextEvent.note}</h4><p class="text-sm mt-1 font-medium opacity-90"><i class="fa-regular fa-calendar mr-1"></i> ${isTodayEvent ? 'HOY' : eventDateStr} • ${nextEvent.eventTime}</p></div></div>`;
            }
            const pendingTodos = (state.todos || []).filter(t => !t.done);
            const lovePhrases = ["¡Turno exitoso, Dra!", "La mejor doctora 🫀", "¡A salvar vidas!", "Vocación y corazón 🩷", "Dra. Monita al rescate"];
            const greeting = lovePhrases[Math.floor(Math.random() * lovePhrases.length)];
            let shiftCardClass = "bg-white border-slate-200 text-slate-500";
            let shiftText = "Sin turnos asignados";
            let shiftSubText = "Revisa tu calendario";
            let shiftIcon = "fa-calendar-check"; 
            if (shift) {
                if (shift.type === 'guardia') { shiftCardClass = "bg-red-50 border-red-100 text-red-600"; shiftText = "PASO"; shiftSubText = "Visita de Sala"; shiftIcon = "fa-user-doctor"; }
                else if (shift.type === 'dia') { shiftCardClass = "bg-blue-50 border-blue-100 text-blue-600"; shiftText = "TURNO DÍA"; shiftSubText = "Jornada Diurna"; shiftIcon = "fa-sun"; }
                else if (shift.type === 'noche') { shiftCardClass = "bg-indigo-50 border-indigo-100 text-indigo-600"; shiftText = "TURNO NOCHE"; shiftSubText = "Jornada Nocturna"; shiftIcon = "fa-moon"; }
                else if (shift.type === 'post') { shiftCardClass = "bg-orange-50 border-orange-100 text-orange-600"; shiftText = "DÍA DE ESTUDIO"; shiftSubText = "Tiempo de estudio"; shiftIcon = "fa-book-open"; }
                else if (shift.type === 'libre') { shiftCardClass = "bg-emerald-50 border-emerald-100 text-emerald-600"; shiftText = "DÍA LIBRE"; shiftSubText = "Recarga energías"; shiftIcon = "fa-mug-hot"; }
                if (isNextShift && shift.type !== 'libre') shiftSubText = `Próximo: ${nextDateStr}`;
            }
            const profileImageSrc = state.userProfileImage || 'catita.png';
            const displayUserName = state.userName || 'Dra.';
            const patientsListContent = generatePatientsHTML();
            return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-full min-h-full pb-8"><div class="order-4 lg:order-1 lg:col-span-1 lg:min-w-[350px] flex flex-col lg:h-full h-auto"><div class="flex justify-between items-center mb-4 sticky top-0 bg-[#f8fafc] z-10 py-2"><h2 class="text-3xl font-black text-slate-700 flex items-center gap-2"><i class="fa-solid fa-clipboard-user text-blue-500"></i> Fichas</h2><button onclick="openPatientModal()" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition"><i class="fa-solid fa-plus mr-1"></i> Ingresar</button></div><div id="patients-list-container" class="lg:flex-1 lg:overflow-y-auto lg:pr-1 w-full hide-scrollbar">${patientsListContent}</div></div><div class="contents lg:flex lg:flex-col lg:gap-6 lg:order-2 lg:col-span-2 lg:overflow-y-auto lg:p-6 lg:h-full hide-scrollbar"><div class="order-1 flex items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 shrink-0"><div class="relative w-20 h-20 shrink-0 group cursor-pointer"><div class="absolute inset-0 bg-pink-100 rounded-full animate-pulse"></div><label for="profile-upload" class="cursor-pointer"><img src="${profileImageSrc}" class="w-20 h-20 rounded-full object-cover border-2 border-white shadow relative z-10 group-hover:opacity-80 transition" onerror="this.src='https://via.placeholder.com/64?text=Dra'"><div class="absolute inset-0 z-20 flex items-center justify-center bg-black/30 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-white text-sm"></i></div></label><input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="updateProfileImage(this)"><div class="absolute -bottom-1 -right-1 bg-green-400 w-6 h-6 rounded-full border-2 border-white flex items-center justify-center z-20 pointer-events-none"><i class="fa-solid fa-check text-xs text-white"></i></div></div><div><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Estado Actual</p><h2 class="text-2xl font-bold text-slate-700 leading-tight flex items-center gap-2 cursor-pointer hover:text-pink-600 transition" onclick="openNameModal()" title="Clic para editar nombre">Hola, ${displayUserName} <i class="fa-solid fa-pen-to-square text-sm text-slate-300"></i></h2><p class="text-lg text-pink-500 font-medium italic">"${greeting}"</p></div></div><div onclick="renderView('turnario')" class="order-2 cursor-pointer relative overflow-hidden rounded-2xl border-2 ${shiftCardClass.replace('bg-', 'border-').replace('text-', 'border-')} p-0 transition-transform active:scale-95 shadow-sm shrink-0"><div class="${shiftCardClass} p-6 relative z-10"><div class="flex justify-between items-start"><div><span class="text-xs font-bold uppercase tracking-widest opacity-70 mb-1 block">Asignación ${isNextShift ? 'Próxima' : 'de Hoy'}</span><h3 class="text-3xl font-black tracking-tight mb-1">${shiftText}</h3><p class="text-lg font-medium opacity-80 flex items-center gap-1"><i class="fa-solid fa-circle-info text-sm"></i> ${shiftSubText}</p></div><div class="w-14 h-14 rounded-xl bg-white/50 flex items-center justify-center backdrop-blur-sm shadow-sm"><i class="fa-solid ${shiftIcon} text-3xl opacity-90"></i></div></div></div><div class="absolute -right-4 -bottom-8 opacity-10 pointer-events-none"><i class="fa-solid fa-heart-pulse text-9xl"></i></div></div>${reminderHTML}<div class="order-5 grid grid-cols-2 gap-3 shrink-0"><div onclick="renderView('todo')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 hover:border-pink-200 transition group cursor-pointer"><div class="w-12 h-12 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-clipboard-list text-2xl"></i></div><span class="text-sm font-bold text-slate-600">Pendientes (${pendingTodos.length})</span></div><div onclick="renderView('notes')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 hover:border-blue-200 transition group cursor-pointer"><div class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center group-hover:scale-110 transition"><i class="fa-solid fa-file-medical text-2xl"></i></div><span class="text-sm font-bold text-slate-600">Mis Apuntes</span></div></div><div class="order-6 pt-4 border-t border-slate-200/60 pb-8 shrink-0"><p class="text-xs text-center text-slate-400 uppercase tracking-widest font-bold mb-4">Equipo Médico de Guardia</p><div class="flex justify-center gap-6"><div class="relative group"><div class="absolute -inset-1 bg-gradient-to-r from-pink-400 to-purple-400 rounded-full blur opacity-25 group-hover:opacity-50 transition"></div><img src="catita.png" class="w-24 h-24 object-contain relative z-10 drop-shadow-lg transform hover:scale-110 transition duration-300" onerror="this.style.display='none'"></div><div class="relative group"><div class="absolute -inset-1 bg-gradient-to-r from-blue-400 to-teal-400 rounded-full blur opacity-25 group-hover:opacity-50 transition"></div><img src="catita2.png" class="w-24 h-24 object-contain relative z-10 drop-shadow-lg transform hover:scale-110 transition duration-300" onerror="this.style.display='none'"></div></div></div></div></div>`;
        }

        function createPatientCardHTML(p) {
            const tasksHTML = p.tasks.map(t => createPatientTaskHTML(t, p.id)).join('');
            return `<div id="patient-card-${p.id}" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition group relative mb-3 fade-enter"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-700 text-2xl leading-none">${p.name}</h4><div class="flex gap-2 mt-1"><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider"><i class="fa-solid fa-bed mr-1"></i> ${p.room}</span><span class="bg-slate-50 text-slate-500 px-2 py-0.5 rounded text-xs font-bold uppercase truncate max-w-[120px]">${p.dx}</span></div></div><button onclick="deletePatient(${p.id})" class="text-slate-300 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can text-lg"></i></button></div><div class="mt-3 pl-1 border-l-2 border-slate-100"><div id="patient-tasks-${p.id}">${tasksHTML}</div><div class="flex items-center gap-2 mt-2"><input type="text" id="new-task-input-${p.id}" placeholder="+ Pendiente..." class="bg-transparent text-lg outline-none w-full placeholder-slate-300 focus:placeholder-blue-300 text-slate-600" onkeypress="if(event.key === 'Enter') addPatientTask(${p.id})"><button onclick="addPatientTask(${p.id})" class="text-blue-400 hover:text-blue-600 text-lg"><i class="fa-solid fa-plus"></i></button></div></div></div>`;
        }
        function createPatientTaskHTML(t, patientId) {
            return `<div id="patient-task-${t.id}" class="flex items-center gap-2 group/task mb-1 item-enter"><button onclick="togglePatientTask(${patientId}, ${t.id})" id="btn-ptask-${t.id}" class="text-sm ${t.done ? 'text-green-500' : 'text-slate-300 hover:text-pink-500'} transition"><i class="fa-${t.done ? 'solid' : 'regular'} fa-circle-check"></i></button><span id="txt-ptask-${t.id}" class="text-lg flex-1 ${t.done ? 'text-slate-400 line-through' : 'text-slate-600 font-medium'}">${t.text}</span><button onclick="deletePatientTask(${patientId}, ${t.id})" class="text-slate-200 hover:text-red-400 opacity-0 group-hover/task:opacity-100 transition"><i class="fa-solid fa-xmark"></i></button></div>`;
        }
        function generatePatientsHTML() {
            if ((state.patients || []).length === 0) return `<div id="empty-patients-msg" class="bg-white p-8 rounded-2xl border-2 border-dashed border-slate-200 text-center flex flex-col items-center justify-center h-48 fade-enter"><i class="fa-solid fa-bed-pulse text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 font-bold text-lg">Sin pacientes ingresados</p><p class="text-slate-300 text-sm">Agrega uno para comenzar ronda</p></div>`;
            return state.patients.map(p => createPatientCardHTML(p)).join('');
        }
        function createPatient() {
            const name = document.getElementById('patient-name').value.trim();
            const room = document.getElementById('patient-room').value.trim();
            const dx = document.getElementById('patient-dx').value.trim();
            if (!name) return;
            const newPatient = { id: Date.now(), name, room: room || '---', dx: dx || 'En estudio', tasks: [] };
            state.patients.unshift(newPatient);
            saveData();
            closePatientModal();
            const container = document.getElementById('patients-list-container');
            if (container) {
                const emptyMsg = document.getElementById('empty-patients-msg');
                if (emptyMsg) emptyMsg.remove();
                container.insertAdjacentHTML('afterbegin', createPatientCardHTML(newPatient));
            } else { renderView('dashboard'); }
            showToast("Paciente Ingresado", "fa-user-plus");
        }
        function deletePatient(id) {
            showConfirmModal("¿Dar de alta?", "Se eliminará la ficha y pendientes.", "Dar de Alta", () => {
                state.patients = state.patients.filter(p => p.id !== id);
                saveData();
                closeConfirmModal();
                const card = document.getElementById(`patient-card-${id}`);
                if (card) {
                    card.classList.add('item-leave');
                    setTimeout(() => { 
                        card.remove(); 
                        const container = document.getElementById('patients-list-container');
                        if (container && container.children.length === 0) container.innerHTML = generatePatientsHTML();
                    }, 300);
                } else { renderView('dashboard'); }
                showToast("Paciente dado de alta", "fa-user-minus");
            });
        }
        function addPatientTask(patientId) {
            const input = document.getElementById(`new-task-input-${patientId}`);
            if(!input) return;
            const text = input.value.trim();
            if(!text) return;
            const patient = state.patients.find(p => p.id === patientId);
            if(patient) {
                const newTask = { id: Date.now(), text, done: false };
                patient.tasks.push(newTask);
                saveData();
                const tasksContainer = document.getElementById(`patient-tasks-${patientId}`);
                if(tasksContainer) tasksContainer.insertAdjacentHTML('beforeend', createPatientTaskHTML(newTask, patientId));
                input.value = '';
                input.focus();
            }
        }
        function togglePatientTask(patientId, taskId) {
            const patient = state.patients.find(p => p.id === patientId);
            if(patient) {
                const task = patient.tasks.find(t => t.id === taskId);
                if(task) {
                    task.done = !task.done;
                    saveData();
                    const btn = document.getElementById(`btn-ptask-${taskId}`);
                    const txt = document.getElementById(`txt-ptask-${taskId}`);
                    if(btn && txt) {
                        btn.className = `text-sm ${task.done ? 'text-green-500' : 'text-slate-300 hover:text-pink-500'} transition`;
                        btn.innerHTML = `<i class="fa-${task.done ? 'solid' : 'regular'} fa-circle-check"></i>`;
                        txt.className = `text-lg flex-1 ${task.done ? 'text-slate-400 line-through' : 'text-slate-600 font-medium'}`;
                    }
                }
            }
        }
        function deletePatientTask(patientId, taskId) {
             const patient = state.patients.find(p => p.id === patientId);
             if(patient) {
                 patient.tasks = patient.tasks.filter(t => t.id !== taskId);
                 saveData();
                 const taskEl = document.getElementById(`patient-task-${taskId}`);
                 if(taskEl) taskEl.remove();
             }
        }
        function deleteCurrentShift() {
            if (selectedDateKey) {
                delete state.shifts[selectedDateKey];
                saveData();
                closeModal();
                if (state.view === 'turnario') renderView('turnario'); else renderView('dashboard');
                showToast("Evento eliminado", "fa-trash");
            }
        }
        function renderView(viewName) {
            const container = document.getElementById('app-container');
            state.view = viewName;
            state.editingNoteId = null;
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewName) btn.classList.add('active'); else btn.classList.remove('active');
            });
            let contentHTML = '';
            let containerClass = "fade-enter h-full ";
            if (viewName === 'dashboard' || viewName === 'notes' || viewName === 'links') containerClass += "w-full max-w-7xl mx-auto"; else containerClass += "max-w-md mx-auto";
            try {
                switch(viewName) {
                    case 'dashboard': contentHTML = getDashboardHTML(); break;
                    case 'turnario': contentHTML = getTurnarioHTML(); break;
                    case 'todo': contentHTML = getTodoHTML(); break;
                    case 'notes': contentHTML = getNotesHTML(); break;
                    case 'links': contentHTML = getLinksHTML(); break;
                    default: contentHTML = getDashboardHTML(); 
                }
            } catch (e) { console.error("Error renderizando vista:", e); contentHTML = `<div class="p-8 text-center text-red-400">Error de renderizado.</div>`; }
            const wrapper = document.createElement('div');
            wrapper.className = containerClass;
            wrapper.innerHTML = contentHTML;
            container.replaceChildren(wrapper);
            container.scrollTop = 0;
            if (viewName === 'notes') {
                const imgInput = document.getElementById('new-note-image');
                if(imgInput) imgInput.addEventListener('change', function() { previewImage(this); });
            }
            saveData();
        }

        init();
    </script>
</body>
</html>
